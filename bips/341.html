<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>341 | Bitcoin Docs</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="apple-touch-icon" sizes="180x180" href="bitcoin.png">
    <link rel="icon" type="image/png" sizes="32x32" href="bitcoin.png">
    <link rel="icon" type="image/png" sizes="16x16" href="bitcoin.png">
    <link rel="mask-icon" href="bitcoin.png" color="#3a0839">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="icon" href="bitcoin.png">
    <meta name="description" content="">
    <meta name="theme-color" content="#ff7e00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/bitcoindocs/assets/css/0.styles.6b9516dd.css" as="style"><link rel="preload" href="/bitcoindocs/assets/js/app.c31d8641.js" as="script"><link rel="preload" href="/bitcoindocs/assets/js/2.b78a9106.js" as="script"><link rel="preload" href="/bitcoindocs/assets/js/87.a547f760.js" as="script"><link rel="prefetch" href="/bitcoindocs/assets/js/10.68a64a6d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/100.bd554273.js"><link rel="prefetch" href="/bitcoindocs/assets/js/101.df38dcc3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/102.3bf2a9d4.js"><link rel="prefetch" href="/bitcoindocs/assets/js/103.d879654a.js"><link rel="prefetch" href="/bitcoindocs/assets/js/104.fcff9e3b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/105.324f3006.js"><link rel="prefetch" href="/bitcoindocs/assets/js/106.b8b3ca20.js"><link rel="prefetch" href="/bitcoindocs/assets/js/107.4a9863c3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/108.e93a5196.js"><link rel="prefetch" href="/bitcoindocs/assets/js/109.e770824e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/11.f67301bd.js"><link rel="prefetch" href="/bitcoindocs/assets/js/110.72ba2ba4.js"><link rel="prefetch" href="/bitcoindocs/assets/js/111.a33eb12f.js"><link rel="prefetch" href="/bitcoindocs/assets/js/112.ecf1c295.js"><link rel="prefetch" href="/bitcoindocs/assets/js/113.85f94e5b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/114.c79655f2.js"><link rel="prefetch" href="/bitcoindocs/assets/js/115.3940b629.js"><link rel="prefetch" href="/bitcoindocs/assets/js/116.9ead4ccc.js"><link rel="prefetch" href="/bitcoindocs/assets/js/117.d4b75110.js"><link rel="prefetch" href="/bitcoindocs/assets/js/118.87575c0c.js"><link rel="prefetch" href="/bitcoindocs/assets/js/119.65af5cbd.js"><link rel="prefetch" href="/bitcoindocs/assets/js/12.fc1e786f.js"><link rel="prefetch" href="/bitcoindocs/assets/js/120.99826b18.js"><link rel="prefetch" href="/bitcoindocs/assets/js/121.608c453c.js"><link rel="prefetch" href="/bitcoindocs/assets/js/122.b24765eb.js"><link rel="prefetch" href="/bitcoindocs/assets/js/123.64680142.js"><link rel="prefetch" href="/bitcoindocs/assets/js/124.4b4f9bc2.js"><link rel="prefetch" href="/bitcoindocs/assets/js/125.0e07a49d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/126.be3bae0f.js"><link rel="prefetch" href="/bitcoindocs/assets/js/127.3d041c50.js"><link rel="prefetch" href="/bitcoindocs/assets/js/128.5feda1e3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/129.307399ad.js"><link rel="prefetch" href="/bitcoindocs/assets/js/13.47ba1b02.js"><link rel="prefetch" href="/bitcoindocs/assets/js/130.0659f005.js"><link rel="prefetch" href="/bitcoindocs/assets/js/131.69a612f3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/132.b51e17e2.js"><link rel="prefetch" href="/bitcoindocs/assets/js/133.7bb492d9.js"><link rel="prefetch" href="/bitcoindocs/assets/js/134.0f7e8787.js"><link rel="prefetch" href="/bitcoindocs/assets/js/135.e2504a16.js"><link rel="prefetch" href="/bitcoindocs/assets/js/136.8b6c7216.js"><link rel="prefetch" href="/bitcoindocs/assets/js/137.e38fc5b2.js"><link rel="prefetch" href="/bitcoindocs/assets/js/138.095843e4.js"><link rel="prefetch" href="/bitcoindocs/assets/js/139.4a5e77fb.js"><link rel="prefetch" href="/bitcoindocs/assets/js/14.42b93c7a.js"><link rel="prefetch" href="/bitcoindocs/assets/js/140.f517d934.js"><link rel="prefetch" href="/bitcoindocs/assets/js/141.7a6497c0.js"><link rel="prefetch" href="/bitcoindocs/assets/js/142.8ae1c029.js"><link rel="prefetch" href="/bitcoindocs/assets/js/143.2fadb8ac.js"><link rel="prefetch" href="/bitcoindocs/assets/js/144.a64d8f22.js"><link rel="prefetch" href="/bitcoindocs/assets/js/145.1b1fa851.js"><link rel="prefetch" href="/bitcoindocs/assets/js/146.a59efe37.js"><link rel="prefetch" href="/bitcoindocs/assets/js/147.a0a8fc92.js"><link rel="prefetch" href="/bitcoindocs/assets/js/148.e177254d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/149.88223d18.js"><link rel="prefetch" href="/bitcoindocs/assets/js/15.cdd298ba.js"><link rel="prefetch" href="/bitcoindocs/assets/js/150.c07e2220.js"><link rel="prefetch" href="/bitcoindocs/assets/js/151.843c50f7.js"><link rel="prefetch" href="/bitcoindocs/assets/js/152.4f34674a.js"><link rel="prefetch" href="/bitcoindocs/assets/js/153.c2ba1434.js"><link rel="prefetch" href="/bitcoindocs/assets/js/154.dec4842c.js"><link rel="prefetch" href="/bitcoindocs/assets/js/155.ecd7b99f.js"><link rel="prefetch" href="/bitcoindocs/assets/js/156.55d078d3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/157.44501232.js"><link rel="prefetch" href="/bitcoindocs/assets/js/158.79220932.js"><link rel="prefetch" href="/bitcoindocs/assets/js/159.33765ed3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/16.4c7eeecf.js"><link rel="prefetch" href="/bitcoindocs/assets/js/160.ea470a70.js"><link rel="prefetch" href="/bitcoindocs/assets/js/161.2dc38d81.js"><link rel="prefetch" href="/bitcoindocs/assets/js/162.a27303c6.js"><link rel="prefetch" href="/bitcoindocs/assets/js/163.31e293c1.js"><link rel="prefetch" href="/bitcoindocs/assets/js/164.fca747d6.js"><link rel="prefetch" href="/bitcoindocs/assets/js/165.52456cdd.js"><link rel="prefetch" href="/bitcoindocs/assets/js/166.c2464f79.js"><link rel="prefetch" href="/bitcoindocs/assets/js/167.25467097.js"><link rel="prefetch" href="/bitcoindocs/assets/js/168.92664946.js"><link rel="prefetch" href="/bitcoindocs/assets/js/169.df73d115.js"><link rel="prefetch" href="/bitcoindocs/assets/js/17.b107683f.js"><link rel="prefetch" href="/bitcoindocs/assets/js/170.08fb6e7e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/171.ba749017.js"><link rel="prefetch" href="/bitcoindocs/assets/js/172.c92581cb.js"><link rel="prefetch" href="/bitcoindocs/assets/js/173.1fce2c58.js"><link rel="prefetch" href="/bitcoindocs/assets/js/174.34c08943.js"><link rel="prefetch" href="/bitcoindocs/assets/js/175.0f3c7a0d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/176.36c2e712.js"><link rel="prefetch" href="/bitcoindocs/assets/js/177.15027195.js"><link rel="prefetch" href="/bitcoindocs/assets/js/178.a42c47f3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/179.e9af4276.js"><link rel="prefetch" href="/bitcoindocs/assets/js/18.608ae665.js"><link rel="prefetch" href="/bitcoindocs/assets/js/180.48a51584.js"><link rel="prefetch" href="/bitcoindocs/assets/js/181.cc255bc5.js"><link rel="prefetch" href="/bitcoindocs/assets/js/182.64362e5e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/183.256b3077.js"><link rel="prefetch" href="/bitcoindocs/assets/js/184.3139561e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/185.5af948dd.js"><link rel="prefetch" href="/bitcoindocs/assets/js/19.8b76fc9c.js"><link rel="prefetch" href="/bitcoindocs/assets/js/20.122a4ef0.js"><link rel="prefetch" href="/bitcoindocs/assets/js/21.1f8a8820.js"><link rel="prefetch" href="/bitcoindocs/assets/js/22.eb68688b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/23.9e751fd9.js"><link rel="prefetch" href="/bitcoindocs/assets/js/24.72ecb396.js"><link rel="prefetch" href="/bitcoindocs/assets/js/25.ad100f49.js"><link rel="prefetch" href="/bitcoindocs/assets/js/26.654fcf2f.js"><link rel="prefetch" href="/bitcoindocs/assets/js/27.fdb46ea9.js"><link rel="prefetch" href="/bitcoindocs/assets/js/28.b28d1103.js"><link rel="prefetch" href="/bitcoindocs/assets/js/29.979a7705.js"><link rel="prefetch" href="/bitcoindocs/assets/js/3.0ccb3eb1.js"><link rel="prefetch" href="/bitcoindocs/assets/js/30.27ab6b09.js"><link rel="prefetch" href="/bitcoindocs/assets/js/31.0b51055d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/32.e5d3f476.js"><link rel="prefetch" href="/bitcoindocs/assets/js/33.5325af50.js"><link rel="prefetch" href="/bitcoindocs/assets/js/34.6cc1e8e6.js"><link rel="prefetch" href="/bitcoindocs/assets/js/35.4f93edf4.js"><link rel="prefetch" href="/bitcoindocs/assets/js/36.56c4b763.js"><link rel="prefetch" href="/bitcoindocs/assets/js/37.d7fc3cc3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/38.ba47e0be.js"><link rel="prefetch" href="/bitcoindocs/assets/js/39.a4948230.js"><link rel="prefetch" href="/bitcoindocs/assets/js/4.f750dbd8.js"><link rel="prefetch" href="/bitcoindocs/assets/js/40.13f04ebc.js"><link rel="prefetch" href="/bitcoindocs/assets/js/41.efba2874.js"><link rel="prefetch" href="/bitcoindocs/assets/js/42.71cd6fcf.js"><link rel="prefetch" href="/bitcoindocs/assets/js/43.3dd10508.js"><link rel="prefetch" href="/bitcoindocs/assets/js/44.0e0f5018.js"><link rel="prefetch" href="/bitcoindocs/assets/js/45.4e467a20.js"><link rel="prefetch" href="/bitcoindocs/assets/js/46.fbc682be.js"><link rel="prefetch" href="/bitcoindocs/assets/js/47.79e3cde6.js"><link rel="prefetch" href="/bitcoindocs/assets/js/48.36d1a4f2.js"><link rel="prefetch" href="/bitcoindocs/assets/js/49.5c861a4e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/5.8f3d1a69.js"><link rel="prefetch" href="/bitcoindocs/assets/js/50.0c7609ac.js"><link rel="prefetch" href="/bitcoindocs/assets/js/51.6497b8ba.js"><link rel="prefetch" href="/bitcoindocs/assets/js/52.6fef223e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/53.dc5dd169.js"><link rel="prefetch" href="/bitcoindocs/assets/js/54.560108ca.js"><link rel="prefetch" href="/bitcoindocs/assets/js/55.a09c65a8.js"><link rel="prefetch" href="/bitcoindocs/assets/js/56.f7f7c539.js"><link rel="prefetch" href="/bitcoindocs/assets/js/57.3b3dfb34.js"><link rel="prefetch" href="/bitcoindocs/assets/js/58.1048b51d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/59.01f56552.js"><link rel="prefetch" href="/bitcoindocs/assets/js/6.ea542132.js"><link rel="prefetch" href="/bitcoindocs/assets/js/60.1e424058.js"><link rel="prefetch" href="/bitcoindocs/assets/js/61.6d4493b3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/62.849c30d7.js"><link rel="prefetch" href="/bitcoindocs/assets/js/63.0c6aaa64.js"><link rel="prefetch" href="/bitcoindocs/assets/js/64.0d99b925.js"><link rel="prefetch" href="/bitcoindocs/assets/js/65.d60db57e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/66.c6c02735.js"><link rel="prefetch" href="/bitcoindocs/assets/js/67.c0c64c59.js"><link rel="prefetch" href="/bitcoindocs/assets/js/68.99f833eb.js"><link rel="prefetch" href="/bitcoindocs/assets/js/69.88769157.js"><link rel="prefetch" href="/bitcoindocs/assets/js/7.474d9a1c.js"><link rel="prefetch" href="/bitcoindocs/assets/js/70.0a746051.js"><link rel="prefetch" href="/bitcoindocs/assets/js/71.9847fc9b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/72.8e04fa9b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/73.772916a2.js"><link rel="prefetch" href="/bitcoindocs/assets/js/74.9663297b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/75.66154da0.js"><link rel="prefetch" href="/bitcoindocs/assets/js/76.358626cf.js"><link rel="prefetch" href="/bitcoindocs/assets/js/77.8eafda69.js"><link rel="prefetch" href="/bitcoindocs/assets/js/78.782695f1.js"><link rel="prefetch" href="/bitcoindocs/assets/js/79.99523f6b.js"><link rel="prefetch" href="/bitcoindocs/assets/js/8.7a9d23a8.js"><link rel="prefetch" href="/bitcoindocs/assets/js/80.2c556ea8.js"><link rel="prefetch" href="/bitcoindocs/assets/js/81.b70d3d0d.js"><link rel="prefetch" href="/bitcoindocs/assets/js/82.f0c621cf.js"><link rel="prefetch" href="/bitcoindocs/assets/js/83.13117f68.js"><link rel="prefetch" href="/bitcoindocs/assets/js/84.2361b62a.js"><link rel="prefetch" href="/bitcoindocs/assets/js/85.e8f23ad0.js"><link rel="prefetch" href="/bitcoindocs/assets/js/86.eab303cd.js"><link rel="prefetch" href="/bitcoindocs/assets/js/88.3c748686.js"><link rel="prefetch" href="/bitcoindocs/assets/js/89.6b7de962.js"><link rel="prefetch" href="/bitcoindocs/assets/js/9.6e1ca0bd.js"><link rel="prefetch" href="/bitcoindocs/assets/js/90.0907331e.js"><link rel="prefetch" href="/bitcoindocs/assets/js/91.fe47eeeb.js"><link rel="prefetch" href="/bitcoindocs/assets/js/92.f4c67fe3.js"><link rel="prefetch" href="/bitcoindocs/assets/js/93.efdc2e47.js"><link rel="prefetch" href="/bitcoindocs/assets/js/94.b7862723.js"><link rel="prefetch" href="/bitcoindocs/assets/js/95.06e410a5.js"><link rel="prefetch" href="/bitcoindocs/assets/js/96.0cc67031.js"><link rel="prefetch" href="/bitcoindocs/assets/js/97.b9460d90.js"><link rel="prefetch" href="/bitcoindocs/assets/js/98.0689894c.js"><link rel="prefetch" href="/bitcoindocs/assets/js/99.f18fe9ac.js">
    <link rel="stylesheet" href="/bitcoindocs/assets/css/0.styles.6b9516dd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bitcoindocs/" class="home-link router-link-active"><!----> <span class="site-name">Bitcoin Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bitcoindocs/whitepaper/" class="nav-link">
  Whitepaper
</a></div><div class="nav-item"><a href="/bitcoindocs/releases/" class="nav-link">
  Releases
</a></div><div class="nav-item"><a href="/bitcoindocs/bips/" class="nav-link router-link-active">
  BIPs
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bitcoindocs/whitepaper/" class="nav-link">
  Whitepaper
</a></div><div class="nav-item"><a href="/bitcoindocs/releases/" class="nav-link">
  Releases
</a></div><div class="nav-item"><a href="/bitcoindocs/bips/" class="nav-link router-link-active">
  BIPs
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>BIPs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bitcoindocs/bips/" aria-current="page" class="sidebar-link">Bitcoin Improvement Proposals</a></li><li><a href="/bitcoindocs/bips/1.html" class="sidebar-link">1</a></li><li><a href="/bitcoindocs/bips/2.html" class="sidebar-link">2</a></li><li><a href="/bitcoindocs/bips/8.html" class="sidebar-link">8</a></li><li><a href="/bitcoindocs/bips/9.html" class="sidebar-link">9</a></li><li><a href="/bitcoindocs/bips/16.html" class="sidebar-link">16</a></li><li><a href="/bitcoindocs/bips/32.html" class="sidebar-link">32</a></li><li><a href="/bitcoindocs/bips/39.html" class="sidebar-link">39</a></li><li><a href="/bitcoindocs/bips/42.html" class="sidebar-link">42</a></li><li><a href="/bitcoindocs/bips/43.html" class="sidebar-link">43</a></li><li><a href="/bitcoindocs/bips/44.html" class="sidebar-link">44</a></li><li><a href="/bitcoindocs/bips/45.html" class="sidebar-link">45</a></li><li><a href="/bitcoindocs/bips/47.html" class="sidebar-link">47</a></li><li><a href="/bitcoindocs/bips/49.html" class="sidebar-link">49</a></li><li><a href="/bitcoindocs/bips/50.html" class="sidebar-link">50</a></li><li><a href="/bitcoindocs/bips/60.html" class="sidebar-link">60</a></li><li><a href="/bitcoindocs/bips/61.html" class="sidebar-link">61</a></li><li><a href="/bitcoindocs/bips/62.html" class="sidebar-link">62</a></li><li><a href="/bitcoindocs/bips/64.html" class="sidebar-link">64</a></li><li><a href="/bitcoindocs/bips/65.html" class="sidebar-link">65</a></li><li><a href="/bitcoindocs/bips/66.html" class="sidebar-link">66</a></li><li><a href="/bitcoindocs/bips/67.html" class="sidebar-link">67</a></li><li><a href="/bitcoindocs/bips/68.html" class="sidebar-link">68</a></li><li><a href="/bitcoindocs/bips/69.html" class="sidebar-link">69</a></li><li><a href="/bitcoindocs/bips/70.html" class="sidebar-link">70</a></li><li><a href="/bitcoindocs/bips/71.html" class="sidebar-link">71</a></li><li><a href="/bitcoindocs/bips/72.html" class="sidebar-link">72</a></li><li><a href="/bitcoindocs/bips/73.html" class="sidebar-link">73</a></li><li><a href="/bitcoindocs/bips/74.html" class="sidebar-link">74</a></li><li><a href="/bitcoindocs/bips/75.html" class="sidebar-link">75</a></li><li><a href="/bitcoindocs/bips/78.html" class="sidebar-link">78</a></li><li><a href="/bitcoindocs/bips/79.html" class="sidebar-link">79</a></li><li><a href="/bitcoindocs/bips/80.html" class="sidebar-link">80</a></li><li><a href="/bitcoindocs/bips/81.html" class="sidebar-link">81</a></li><li><a href="/bitcoindocs/bips/83.html" class="sidebar-link">83</a></li><li><a href="/bitcoindocs/bips/84.html" class="sidebar-link">84</a></li><li><a href="/bitcoindocs/bips/85.html" class="sidebar-link">85</a></li><li><a href="/bitcoindocs/bips/90.html" class="sidebar-link">90</a></li><li><a href="/bitcoindocs/bips/91.html" class="sidebar-link">91</a></li><li><a href="/bitcoindocs/bips/98.html" class="sidebar-link">98</a></li><li><a href="/bitcoindocs/bips/99.html" class="sidebar-link">99</a></li><li><a href="/bitcoindocs/bips/100.html" class="sidebar-link">100</a></li><li><a href="/bitcoindocs/bips/101.html" class="sidebar-link">101</a></li><li><a href="/bitcoindocs/bips/102.html" class="sidebar-link">102</a></li><li><a href="/bitcoindocs/bips/103.html" class="sidebar-link">103</a></li><li><a href="/bitcoindocs/bips/104.html" class="sidebar-link">104</a></li><li><a href="/bitcoindocs/bips/105.html" class="sidebar-link">105</a></li><li><a href="/bitcoindocs/bips/106.html" class="sidebar-link">106</a></li><li><a href="/bitcoindocs/bips/107.html" class="sidebar-link">107</a></li><li><a href="/bitcoindocs/bips/109.html" class="sidebar-link">109</a></li><li><a href="/bitcoindocs/bips/111.html" class="sidebar-link">111</a></li><li><a href="/bitcoindocs/bips/112.html" class="sidebar-link">112</a></li><li><a href="/bitcoindocs/bips/113.html" class="sidebar-link">113</a></li><li><a href="/bitcoindocs/bips/114.html" class="sidebar-link">114</a></li><li><a href="/bitcoindocs/bips/115.html" class="sidebar-link">115</a></li><li><a href="/bitcoindocs/bips/116.html" class="sidebar-link">116</a></li><li><a href="/bitcoindocs/bips/117.html" class="sidebar-link">117</a></li><li><a href="/bitcoindocs/bips/118.html" class="sidebar-link">118</a></li><li><a href="/bitcoindocs/bips/119.html" class="sidebar-link">119</a></li><li><a href="/bitcoindocs/bips/120.html" class="sidebar-link">120</a></li><li><a href="/bitcoindocs/bips/121.html" class="sidebar-link">121</a></li><li><a href="/bitcoindocs/bips/122.html" class="sidebar-link">122</a></li><li><a href="/bitcoindocs/bips/123.html" class="sidebar-link">123</a></li><li><a href="/bitcoindocs/bips/124.html" class="sidebar-link">124</a></li><li><a href="/bitcoindocs/bips/125.html" class="sidebar-link">125</a></li><li><a href="/bitcoindocs/bips/126.html" class="sidebar-link">126</a></li><li><a href="/bitcoindocs/bips/127.html" class="sidebar-link">127</a></li><li><a href="/bitcoindocs/bips/130.html" class="sidebar-link">130</a></li><li><a href="/bitcoindocs/bips/131.html" class="sidebar-link">131</a></li><li><a href="/bitcoindocs/bips/132.html" class="sidebar-link">132</a></li><li><a href="/bitcoindocs/bips/133.html" class="sidebar-link">133</a></li><li><a href="/bitcoindocs/bips/134.html" class="sidebar-link">134</a></li><li><a href="/bitcoindocs/bips/135.html" class="sidebar-link">135</a></li><li><a href="/bitcoindocs/bips/136.html" class="sidebar-link">136</a></li><li><a href="/bitcoindocs/bips/137.html" class="sidebar-link">137</a></li><li><a href="/bitcoindocs/bips/140.html" class="sidebar-link">140</a></li><li><a href="/bitcoindocs/bips/141.html" class="sidebar-link">141</a></li><li><a href="/bitcoindocs/bips/142.html" class="sidebar-link">142</a></li><li><a href="/bitcoindocs/bips/143.html" class="sidebar-link">143</a></li><li><a href="/bitcoindocs/bips/144.html" class="sidebar-link">144</a></li><li><a href="/bitcoindocs/bips/145.html" class="sidebar-link">145</a></li><li><a href="/bitcoindocs/bips/146.html" class="sidebar-link">146</a></li><li><a href="/bitcoindocs/bips/147.html" class="sidebar-link">147</a></li><li><a href="/bitcoindocs/bips/148.html" class="sidebar-link">148</a></li><li><a href="/bitcoindocs/bips/149.html" class="sidebar-link">149</a></li><li><a href="/bitcoindocs/bips/150.html" class="sidebar-link">150</a></li><li><a href="/bitcoindocs/bips/151.html" class="sidebar-link">151</a></li><li><a href="/bitcoindocs/bips/152.html" class="sidebar-link">152</a></li><li><a href="/bitcoindocs/bips/154.html" class="sidebar-link">154</a></li><li><a href="/bitcoindocs/bips/155.html" class="sidebar-link">155</a></li><li><a href="/bitcoindocs/bips/156.html" class="sidebar-link">156</a></li><li><a href="/bitcoindocs/bips/157.html" class="sidebar-link">157</a></li><li><a href="/bitcoindocs/bips/158.html" class="sidebar-link">158</a></li><li><a href="/bitcoindocs/bips/159.html" class="sidebar-link">159</a></li><li><a href="/bitcoindocs/bips/171.html" class="sidebar-link">171</a></li><li><a href="/bitcoindocs/bips/173.html" class="sidebar-link">173</a></li><li><a href="/bitcoindocs/bips/174.html" class="sidebar-link">174</a></li><li><a href="/bitcoindocs/bips/175.html" class="sidebar-link">175</a></li><li><a href="/bitcoindocs/bips/176.html" class="sidebar-link">176</a></li><li><a href="/bitcoindocs/bips/178.html" class="sidebar-link">178</a></li><li><a href="/bitcoindocs/bips/179.html" class="sidebar-link">179</a></li><li><a href="/bitcoindocs/bips/180.html" class="sidebar-link">180</a></li><li><a href="/bitcoindocs/bips/197.html" class="sidebar-link">197</a></li><li><a href="/bitcoindocs/bips/199.html" class="sidebar-link">199</a></li><li><a href="/bitcoindocs/bips/300.html" class="sidebar-link">300</a></li><li><a href="/bitcoindocs/bips/301.html" class="sidebar-link">301</a></li><li><a href="/bitcoindocs/bips/310.html" class="sidebar-link">310</a></li><li><a href="/bitcoindocs/bips/320.html" class="sidebar-link">320</a></li><li><a href="/bitcoindocs/bips/322.html" class="sidebar-link">322</a></li><li><a href="/bitcoindocs/bips/325.html" class="sidebar-link">325</a></li><li><a href="/bitcoindocs/bips/339.html" class="sidebar-link">339</a></li><li><a href="/bitcoindocs/bips/340.html" class="sidebar-link">340</a></li><li><a href="/bitcoindocs/bips/341.html" aria-current="page" class="active sidebar-link">341</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#design" class="sidebar-link">Design</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#specification" class="sidebar-link">Specification</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#constructing-and-spending-taproot-outputs-constructing-and-spending-taproot-outputs" class="sidebar-link">Constructing and spending Taproot outputs {#constructingandspendingtaprootoutputs}</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#security" class="sidebar-link">Security</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#test-vectors-test-vectors" class="sidebar-link">Test vectors {#test_vectors}</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#rationale" class="sidebar-link">Rationale</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#deployment" class="sidebar-link">Deployment</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#backwards-compatibility-backwards-compatibility" class="sidebar-link">Backwards compatibility {#backwards_compatibility}</a></li><li class="sidebar-sub-header"><a href="/bitcoindocs/bips/341.html#acknowledgements" class="sidebar-link">Acknowledgements</a></li></ul></li><li><a href="/bitcoindocs/bips/342.html" class="sidebar-link">342</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_341"><a href="#_341" class="header-anchor">#</a> 341</h1> <div class="language- extra-class"><pre><code>  BIP: 341
  Layer: Consensus (soft fork)
  Title: Taproot: SegWit version 1 spending rules
  Author: Pieter Wuille &lt;pieter.wuille@gmail.com&gt;
          Jonas Nick &lt;jonasd.nick@gmail.com&gt;
          Anthony Towns &lt;aj@erisian.com.au&gt;
  Comments-Summary: No comments yet.
  Comments-URI: https://github.com/bitcoin/bips/wiki/Comments:BIP-0341
  Status: Draft
  Type: Standards Track
  Created: 2020-01-19
  License: BSD-3-Clause
  Requires: 340
  Post-History: 2019-05-06: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2019-May/016914.html [bitcoin-dev] Taproot proposal
                2019-10-09: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2019-October/017378.html [bitcoin-dev] Taproot updates
</code></pre></div><h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <h3 id="abstract"><a href="#abstract" class="header-anchor">#</a> Abstract</h3> <p>This document proposes a new SegWit version 1 output type, with spending
rules based on Taproot, Schnorr signatures, and Merkle branches.</p> <h3 id="copyright"><a href="#copyright" class="header-anchor">#</a> Copyright</h3> <p>This document is licensed under the 3-clause BSD license.</p> <h3 id="motivation"><a href="#motivation" class="header-anchor">#</a> Motivation</h3> <p>This proposal aims to improve privacy, efficiency, and flexibility of
Bitcoin's scripting capabilities without adding new security
assumptions[^1]. Specifically, it seeks to minimize how much information
about the spendability conditions of a transaction output is revealed on
chain at creation or spending time and to add a number of upgrade
mechanisms, while fixing a few minor but long-standing issues.</p> <h2 id="design"><a href="#design" class="header-anchor">#</a> Design</h2> <p>A number of related ideas for improving Bitcoin's scripting
capabilities have been previously proposed: Schnorr signatures
(<a href="bip-0340.mediawiki" title="wikilink">BIP340</a>), Merkle branches (&quot;MAST&quot;,
<a href="bip-0114.mediawiki" title="wikilink">BIP114</a>,
<a href="bip-0117.mediawiki" title="wikilink">BIP117</a>), new sighash modes
(<a href="bip-0118.mediawiki" title="wikilink">BIP118</a>), new opcodes like
CHECKSIGFROMSTACK,
<a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-January/015614.html" target="_blank" rel="noopener noreferrer">Taproot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,
<a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-February/015700.html" target="_blank" rel="noopener noreferrer">Graftroot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,
<a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-July/016249.html" target="_blank" rel="noopener noreferrer">G'root<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,
and <a href="https://bitcointalk.org/index.php?topic=1377298.0" target="_blank" rel="noopener noreferrer">cross-input
aggregation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Combining all these ideas in a single proposal would be an extensive
change, be hard to review, and likely miss new discoveries that
otherwise could have been made along the way. Not all are equally mature
as well. For example, cross-input aggregation
<a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-March/015838.html" target="_blank" rel="noopener noreferrer">interacts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
in complex ways with upgrade mechanisms, and solutions to that are still
<a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-October/016461.html" target="_blank" rel="noopener noreferrer">in
flux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
On the other hand, separating them all into independent upgrades would
reduce the efficiency and privacy gains to be had, and wallet and
service providers may not be inclined to go through many incremental
updates. Therefore, we're faced with a tradeoff between functionality
and scope creep. In this design we strike a balance by focusing on the
structural script improvements offered by Taproot and Merkle branches,
as well as changes necessary to make them usable and efficient. For
things like sighashes and opcodes we include fixes for known problems,
but exclude new features that can be added independently with no
downsides.</p> <p>As a result we choose this combination of technologies:</p> <ul><li><strong>Merkle branches</strong> let us only reveal the actually executed part of
the script to the blockchain, as opposed to all possible ways a
script can be executed. Among the various known mechanisms for
implementing this, one where the Merkle tree becomes part of the
script's structure directly maximizes the space savings, so that
approach is chosen.</li> <li><strong>Taproot</strong> on top of that lets us merge the traditionally separate
pay-to-pubkey and pay-to-scripthash policies, making all outputs
spendable by either a key or (optionally) a script, and
indistinguishable from each other. As long as the key-based spending
path is used for spending, it is not revealed whether a script path
was permitted as well, resulting in space savings and an increase in
scripting privacy at spending time.</li> <li>Taproot's advantages become apparent under the assumption that most
applications involve outputs that could be spent by all parties
agreeing. That's where <strong>Schnorr</strong> signatures come in, as they
permit <a href="https://eprint.iacr.org/2018/068" target="_blank" rel="noopener noreferrer">key aggregation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: a public
key can be constructed from multiple participant public keys, and
which requires cooperation between all participants to sign for.
Such multi-party public keys and signatures are indistinguishable
from their single-party equivalents. This means that with taproot
most applications can use the key-based spending path, which is both
efficient and private. This can be generalized to arbitrary M-of-N
policies, as Schnorr signatures support threshold signing, at the
cost of more complex setup protocols.</li> <li>As Schnorr signatures also permit <strong>batch validation</strong>, allowing
multiple signatures to be validated together more efficiently than
validating each one independently, we make sure all parts of the
design are compatible with this.</li> <li>Where unused bits appear as a result of the above changes, they are
reserved for mechanisms for <strong>future extensions</strong>. As a result,
every script in the Merkle tree has an associated version such that
new script versions can be introduced with a soft fork while
remaining compatible with BIP 341. Additionally, future soft forks
can make use of the currently unused <code>annex</code> in the witness (see
<a href="bip-0341.mediawiki#Rationale" title="wikilink">BIP341</a>).</li> <li>While the core semantics of the <strong>signature hashing algorithm</strong> are
not changed, a number of improvements are included in this proposal.
The new signature hashing algorithm fixes the verification
capabilities of offline signing devices by including amount and
scriptPubKey in the signature message, avoids unnecessary hashing,
uses <strong>tagged hashes</strong> and defines a default sighash byte.</li> <li>The <strong>public key is directly included in the output</strong> in contrast to
typical earlier constructions which store a hash of the public key
or script in the output. This has the same cost for senders and is
more space efficient overall if the key-based spending path is
taken. [^2]</li></ul> <p>Informally, the resulting design is as follows: a new witness version is
added (version 1), whose programs consist of 32-byte encodings of points
<em>Q</em>. <em>Q</em> is computed as <em>P + hash(P||m)G</em> for a public key <em>P</em>, and
the root <em>m</em> of a Merkle tree whose leaves consist of a version number
and a script. These outputs can be spent directly by providing a
signature for <em>Q</em>, or indirectly by revealing <em>P</em>, the script and leaf
version, inputs that satisfy the script, and a Merkle path that proves
<em>Q</em> committed to that leaf. All hashes in this construction (the hash
for computing <em>Q</em> from <em>P</em>, the hashes inside the Merkle tree's inner
nodes, and the signature hashes used) are tagged to guarantee domain
separation.</p> <h2 id="specification"><a href="#specification" class="header-anchor">#</a> Specification</h2> <p>This section specifies the Taproot consensus rules. Validity is defined
by exclusion: a block or transaction is valid if no condition exists
that marks it failed.</p> <p>The notation below follows that of
<a href="bip-0340.mediawiki#design" title="wikilink">BIP340</a>. This includes the
<em>hash~tag~(x)</em> notation to refer to <em>SHA256(SHA256(tag) || SHA256(tag)
|| x)</em>. To the best of the authors' knowledge, no existing use of
SHA256 in Bitcoin feeds it a message that starts with two single SHA256
outputs, making collisions between <em>hash~tag~</em> with other hashes
extremely unlikely.</p> <h3 id="script-validation-rules-script-validation-rules"><a href="#script-validation-rules-script-validation-rules" class="header-anchor">#</a> Script validation rules {#script_validation_rules}</h3> <p>A Taproot output is a native SegWit output (see
<a href="bip-0141.mediawiki" title="wikilink">BIP141</a>) with version number 1, and a
32-byte witness program. The following rules only apply when such an
output is being spent. Any other outputs, including version 1 outputs
with lengths other than 32 bytes, or P2SH-wrapped version 1 outputs[^3],
remain unencumbered.</p> <ul><li>Let <em>q</em> be the 32-byte array containing the witness program (the
second push in the scriptPubKey) which represents a public key
according to <a href="bip-0340.mediawiki#design" title="wikilink">BIP340</a>.</li> <li>Fail if the witness stack has 0 elements.</li> <li>If there are at least two witness elements, and the first byte of
the last element is 0x50[^4], this last element is called <em>annex</em> <em>a</em>[^5] and is removed from the witness stack. The annex (or the
lack of thereof) is always covered by the signature and contributes
to transaction weight, but is otherwise ignored during taproot
validation.</li> <li>If there is exactly one element left in the witness stack, key path
spending is used:
<ul><li>The single witness stack element is interpreted as the signature
and must be valid (see the next section) for the public key <em>q</em>
(see the next subsection).</li></ul></li> <li>If there are at least two witness elements left, script path
spending is used:
<ul><li>Call the second-to-last stack element <em>s</em>, the script.</li> <li>The last stack element is called the control block <em>c</em>, and must
have length <em>33 + 32m</em>, for a value of <em>m</em> that is an integer
between 0 and 128[^6], inclusive. Fail if it does not have such
a length.</li> <li>Let <em>p = c[1:33]</em> and let <em>P = lift_x(int(p))</em> where <em>lift_x</em>
and <em>[:]</em> are defined as in
<a href="bip-0340.mediawiki#design" title="wikilink">BIP340</a>. Fail if this
point is not on the curve.</li> <li>Let <em>v = c[0] &amp; 0xfe</em> and call it the <em>leaf version</em>[^7].</li> <li>Let <em>k~0~ = hash~TapLeaf~(v || compact_size(size of s)
|| s)</em>; also call it the <em>tapleaf hash</em>.</li> <li>For <em>j</em> in <em>[0,1,...,m-1]</em>:
<ul><li>Let <em>e~j~ = c[33+32j:65+32j]</em>.</li> <li>Let ''k~j+1~ depend on whether <em>k~j~ &lt; e~j~</em>
(lexicographically)[^8]:
<ul><li>If <em>k~j~ &lt; e~j~</em>: <em>k~j+1~ = hash~TapBranch~(k~j~ ||
e~j~)</em>[^9].</li> <li>If <em>k~j~ ≥ e~j~</em>: <em>k~j+1~ = hash~TapBranch~(e~j~ ||
k~j~)</em>.</li></ul></li></ul></li> <li>Let <em>t = hash~TapTweak~(p || k~m~)</em>.</li> <li>If <em>t ≥ 0xFFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFE BAAEDCE6 AF48A03B
BFD25E8C D0364141</em> (order of secp256k1), fail.</li> <li>Let <em>Q = P + int(t)G</em>.</li> <li>If <em>q ≠ x(Q)</em> or <em>c[0] &amp; 1 ≠ y(Q) mod 2</em>, fail[^10].</li> <li>Execute the script, according to the applicable script
rules[^11], using the witness stack elements excluding the
script <em>s</em>, the control block <em>c</em>, and the annex <em>a</em> if present,
as initial stack.</li></ul></li></ul> <p><em>q</em> is referred to as <em>taproot output key</em> and <em>p</em> as <em>taproot internal
key</em>.</p> <h3 id="signature-validation-rules-signature-validation-rules"><a href="#signature-validation-rules-signature-validation-rules" class="header-anchor">#</a> Signature validation rules {#signature_validation_rules}</h3> <p>We first define a reusable common signature message calculation
function, followed by the actual signature validation as it's used in
key path spending.</p> <h4 id="common-signature-message-common-signature-message"><a href="#common-signature-message-common-signature-message" class="header-anchor">#</a> Common signature message {#common_signature_message}</h4> <p>The function <em>SigMsg(hash_type, ext_flag)</em> computes the message being
signed as a byte array. It is implicitly also a function of the spending
transaction and the outputs it spends, but these are not listed to keep
notation simple.</p> <p>The parameter <em>hash_type</em> is an 8-bit unsigned value. The <code>SIGHASH</code>
encodings from the legacy script system are reused, including
<code>SIGHASH_ALL</code>, <code>SIGHASH_NONE</code>, <code>SIGHASH_SINGLE</code>, and
<code>SIGHASH_ANYONECANPAY</code>, plus the default <em>hash_type</em> value <em>0x00</em> which
results in signing over the whole transaction just as for <code>SIGHASH_ALL</code>.
The following restrictions apply, which cause validation failure if
violated:</p> <ul><li>Using any undefined <em>hash_type</em> (not <em>0x00</em>, <em>0x01</em>, <em>0x02</em>, <em>0x03</em>,
<em>0x81</em>, <em>0x82</em>, or <em>0x83</em>[^12]).</li> <li>Using <code>SIGHASH_SINGLE</code> without a &quot;corresponding output&quot; (an output
with the same index as the input being verified).</li></ul> <p>The parameter <em>ext_flag</em> is an integer in range 0-127, and is used for
indicating (in the message) that extensions are added at the end of the
message[^13].</p> <p>If the parameters take acceptable values, the message is the
concatenation of the following data, in order (with byte size of each
item listed in parentheses). Numerical values in 2, 4, or 8-byte are
encoded in little-endian.</p> <ul><li>Control:
<ul><li><em>hash_type</em> (1).</li></ul></li> <li>Transaction data:
<ul><li><em>nVersion</em> (4): the <em>nVersion</em> of the transaction.</li> <li><em>nLockTime</em> (4): the <em>nLockTime</em> of the transaction.</li> <li>If the <em>hash_type &amp; 0x80</em> does not equal <code>SIGHASH_ANYONECANPAY</code>:
<ul><li><em>sha_prevouts</em> (32): the SHA256 of the serialization of all
input outpoints.</li> <li><em>sha_amounts</em> (32): the SHA256 of the serialization of all
spent output amounts.</li> <li><em>sha_scriptpubkeys</em> (32): the SHA256 of the serialization of
all spent output <em>scriptPubKey</em>s.</li> <li><em>sha_sequences</em> (32): the SHA256 of the serialization of all
input <em>nSequence</em>.</li></ul></li> <li>If <em>hash_type &amp; 3</em> does not equal <code>SIGHASH_NONE</code> or
<code>SIGHASH_SINGLE</code>:
<ul><li><em>sha_outputs</em> (32): the SHA256 of the serialization of all
outputs in <code>CTxOut</code> format.</li></ul></li></ul></li> <li>Data about this input:
<ul><li><em>spend_type</em> (1): equal to <em>(ext_flag * 2) + annex_present</em>,
where <em>annex_present</em> is 0 if no annex is present, or 1
otherwise (the original witness stack has two or more witness
elements, and the first byte of the last element is <em>0x50</em>)</li> <li>If <em>hash_type &amp; 0x80</em> equals <code>SIGHASH_ANYONECANPAY</code>:
<ul><li><em>outpoint</em> (36): the <code>COutPoint</code> of this input (32-byte
hash + 4-byte little-endian).</li> <li><em>amount</em> (8): value of the previous output spent by this
input.</li> <li><em>scriptPubKey</em> (35): <em>scriptPubKey</em> of the previous output
spent by this input, serialized as script inside <code>CTxOut</code>.
Its size is always 35 bytes.</li> <li><em>nSequence</em> (4): <em>nSequence</em> of this input.</li></ul></li> <li>If <em>hash_type &amp; 0x80</em> does not equal <code>SIGHASH_ANYONECANPAY</code>:
<ul><li><em>input_index</em> (4): index of this input in the transaction
input vector. Index of the first input is 0.</li></ul></li> <li>If an annex is present (the lowest bit of <em>spend_type</em> is set):
<ul><li><em>sha_annex</em> (32): the SHA256 of <em>(compact_size(size of
annex) || annex)</em>, where <em>annex</em> includes the mandatory
<em>0x50</em> prefix.</li></ul></li></ul></li> <li>Data about this output:
<ul><li>If <em>hash_type &amp; 3</em> equals <code>SIGHASH_SINGLE</code>:
<ul><li><em>sha_single_output</em> (32): the SHA256 of the corresponding
output in <code>CTxOut</code> format.</li></ul></li></ul></li></ul> <p>The total length of <em>SigMsg()</em> is at most <em>206</em> bytes[^14]. Note that
this does not include the size of sub-hashes such as <em>sha_prevouts</em>,
which may be cached across signatures of the same transaction.</p> <p>In summary, the semantics of the <a href="bip-0143.mediawiki" title="wikilink">BIP143</a>
sighash types remain unchanged, except the following:</p> <ol><li>The way and order of serialization is changed.[^15]</li> <li>The signature message commits to the <em>scriptPubKey</em> of the spent
output and if the <code>SIGHASH_ANYONECANPAY</code> flag is not set, the
message commits to the <em>scriptPubKey</em>s of <em>all</em> outputs spent by the
transaction. [^16].</li> <li>If the <code>SIGHASH_ANYONECANPAY</code> flag is not set, the message commits
to the amounts of <em>all</em> transaction inputs.[^17]</li> <li>The signature message commits to all input <em>nSequence</em> if
<code>SIGHASH_NONE</code> or <code>SIGHASH_SINGLE</code> are set (unless
<code>SIGHASH_ANYONECANPAY</code> is set as well).[^18]</li> <li>The signature message includes commitments to the taproot-specific
data <em>spend_type</em> and <em>annex</em> (if present).</li></ol> <h4 id="taproot-key-path-spending-signature-validation-taproot-key-path-spending-signature-validation"><a href="#taproot-key-path-spending-signature-validation-taproot-key-path-spending-signature-validation" class="header-anchor">#</a> Taproot key path spending signature validation {#taproot_key_path_spending_signature_validation}</h4> <p>To validate a signature <em>sig</em> with public key <em>q</em>:</p> <ul><li>If the <em>sig</em> is 64 bytes long, return <em>Verify(q,
hash~TapSighash~(0x00 || SigMsg(0x00, 0)), sig)</em>[^19], where
<em>Verify</em> is defined in
<a href="bip-0340.mediawiki#design" title="wikilink">BIP340</a>.</li> <li>If the <em>sig</em> is 65 bytes long, return <em>sig[64] ≠ 0x00[^20] and
Verify(q, hash~TapSighash~(0x00 || SigMsg(sig[64], 0)),
sig[0:64])</em>.</li> <li>Otherwise, fail[^21].</li></ul> <h2 id="constructing-and-spending-taproot-outputs-constructing-and-spending-taproot-outputs"><a href="#constructing-and-spending-taproot-outputs-constructing-and-spending-taproot-outputs" class="header-anchor">#</a> Constructing and spending Taproot outputs {#constructing_and_spending_taproot_outputs}</h2> <p>This section discusses how to construct and spend Taproot outputs. It
only affects wallet software that chooses to implement receiving and
spending, and is not consensus critical in any way.</p> <p>Conceptually, every Taproot output corresponds to a combination of a
single public key condition (the internal key), and zero or more general
conditions encoded in scripts organized in a tree. Satisfying any of
these conditions is sufficient to spend the output.</p> <p><strong>Initial steps</strong> The first step is determining what the internal key
and the organization of the rest of the scripts should be. The specifics
are likely application dependent, but here are some general guidelines:</p> <ul><li>When deciding between scripts with conditionals (<code>OP_IF</code> etc.) and
splitting them up into multiple scripts (each corresponding to one
execution path through the original script), it is generally
preferable to pick the latter.</li> <li>When a single condition requires signatures with multiple keys, key
aggregation techniques like MuSig can be used to combine them into a
single key. The details are out of scope for this document, but note
that this may complicate the signing procedure.</li> <li>If one or more of the spending conditions consist of just a single
key (after aggregation), the most likely one should be made the
internal key. If no such condition exists, it may be worthwhile
adding one that consists of an aggregation of all keys participating
in all scripts combined; effectively adding an &quot;everyone agrees&quot;
branch. If that is inacceptable, pick as internal key a point with
unknown discrete logarithm. One example of such a point is <em>H =
lift_x(0x0250929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0)</em>
which is
<a href="https://github.com/ElementsProject/secp256k1-zkp/blob/11af7015de624b010424273be3d91f117f172c82/src/modules/rangeproof/main_impl.h#L16" target="_blank" rel="noopener noreferrer">constructed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
by taking the hash of the standard uncompressed encoding of the
<a href="https://www.secg.org/sec2-v2.pdf" target="_blank" rel="noopener noreferrer">secp256k1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> base point <em>G</em> as X
coordinate. In order to avoid leaking the information that key path
spending is not possible it is recommended to pick a fresh integer
<em>r</em> in the range <em>0...n-1</em> uniformly at random and use <em>H + rG</em> as
internal key. It is possible to prove that this internal key does
not have a known discrete logarithm with respect to <em>G</em> by revealing
<em>r</em> to a verifier who can then reconstruct how the internal key was
created.</li> <li>If the spending conditions do not require a script path, the output
key should commit to an unspendable script path instead of having no
script path. This can be achieved by computing the output key point
as <em>Q = P + int(hash~TapTweak~(bytes(P)))G</em>. <code>&lt;ref&gt;</code> <strong>Why
should the output key always have a taproot commitment, even if
there is no script path?</strong></li></ul> <p>If the taproot output key is an aggregate of keys, there is the
possibility for a malicious party to add a script path without being
noticed by the other parties. This allows to bypass the multiparty
policy and to steal the coin. MuSig key aggregation does not have this
issue because it already causes the internal key to be randomized.</p> <p>The attack works as follows: Assume Alice and Mallory want to aggregate
their keys into a taproot output key without a script path. In order to
prevent key cancellation and related attacks they use
<a href="https://eprint.iacr.org/2018/483.pdf" target="_blank" rel="noopener noreferrer">MSDL-pop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> instead of MuSig. The
MSDL-pop protocol requires all parties to provide a proof of possession
of their corresponding secret key and the aggregated key is just the sum
of the individual keys. After Mallory receives Alice's key <em>A</em>, Mallory
creates <em>M = M~0~ + int(t)G</em> where <em>M~0~</em> is Mallory's original key and
<em>t</em> allows a script path spend with internal key <em>P = A + M~0~</em> and a
script that only contains Mallory's key. Mallory sends a proof of
possession of <em>M</em> to Alice and both parties compute output key <em>Q = A +
M = P + int(t)G</em>. Alice will not be able to notice the script path, but
Mallory can unilaterally spend any coin with output key <em>Q</em>.
<code>&lt;/ref&gt;</code></p> <ul><li>The remaining scripts should be organized into the leaves of a
binary tree. This can be a balanced tree if each of the conditions
these scripts correspond to are equally likely. If probabilities for
each condition are known, consider constructing the tree as a
Huffman tree.</li></ul> <p><strong>Computing the output script</strong> Once the spending conditions are split
into an internal key <code>internal_pubkey</code> and a binary tree whose leaves
are (leaf_version, script) tuples, the output script can be computed
using the Python3 algorithms below. These algorithms take advantage of
helper functions from the [bip-0340/referency.py BIP340 reference
code] for integer conversion, point multiplication, and tagged hashes.</p> <p>First, we define <code>taproot_tweak_pubkey</code> for 32-byte
<a href="bip-0340.mediawiki" title="wikilink">BIP340</a> public key arrays. The function
returns a bit indicating the tweaked public key's Y coordinate as well
as the public key byte array. The parity bit will be required for
spending the output with a script path. In order to allow spending with
the key path, we define <code>taproot_tweak_seckey</code> to compute the secret key
for a tweaked public key. For any byte string <code>h</code> it holds that
<code>taproot_tweak_pubkey(pubkey_gen(seckey), h)[0] == pubkey_gen(taproot_tweak_seckey(seckey, h))</code>.</p> <div class="language-{.python} line-numbers-mode"><pre class="language-text"><code>def taproot_tweak_pubkey(pubkey, h):
    t = int_from_bytes(tagged_hash(&quot;TapTweak&quot;, pubkey + h))
    if t &gt;= SECP256K1_ORDER:
        raise ValueError
    Q = point_add(lift_x(int_from_bytes(pubkey)), point_mul(G, t))
    return 0 if has_even_y(Q) else 1, bytes_from_int(x(Q))

def taproot_tweak_seckey(seckey0, h):
    P = point_mul(G, int_from_bytes(seckey0))
    seckey = seckey0 if has_even_y(P) else SECP256K1_ORDER - seckey0
    t = int_from_bytes(tagged_hash(&quot;TapTweak&quot;, bytes_from_int(x(P)) + h))
    if t &gt;= SECP256K1_ORDER:
        raise ValueError
    return (seckey + t) % SECP256K1_ORDER
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>The following function, <code>taproot_output_script</code>, returns a byte array
with the scriptPubKey (see <a href="bip-0141.mediawiki" title="wikilink">BIP141</a>).
<code>ser_script</code> refers to a function that prefixes its input with a
CompactSize-encoded length.</p> <div class="language-{.python} line-numbers-mode"><pre class="language-text"><code>def taproot_tree_helper(script_tree):
    if isinstance(script_tree, tuple):
        leaf_version, script = script_tree
        h = tagged_hash(&quot;TapLeaf&quot;, bytes([leaf_version]) + ser_script(script))
        return ([((leaf_version, script), bytes())], h)
    left, left_h = taproot_tree_helper(script_tree[0])
    right, right_h = taproot_tree_helper(script_tree[1])
    ret = [(l, c + right_h) for l, c in left] + [(l, c + left_h) for l, c in right]
    if right_h &lt; left_h:
        left_h, right_h = right_h, left_h
    return (ret, tagged_hash(&quot;TapBranch&quot;, left_h + right_h))

def taproot_output_script(internal_pubkey, script_tree):
    &quot;&quot;&quot;Given a internal public key and a tree of scripts, compute the output script.
    script_tree is either:
     - a (leaf_version, script) tuple (leaf_version is 0xc0 for [[bip-0342.mediawiki|BIP342]] scripts)
     - a list of two elements, each with the same structure as script_tree itself
     - None
    &quot;&quot;&quot;
    if script_tree is None:
        h = bytes()
    else:
        _, h = taproot_tree_helper(script_tree)
    output_pubkey, _ = taproot_tweak_pubkey(internal_pubkey, h)
    return bytes([0x51, 0x20]) + output_pubkey
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><img src="bip-0341/tree.png" alt="This diagram shows the hashing structure to obtain the tweak from aninternal key P and a Merkle tree consisting of 5 script leaves. A,B, C and E are TapLeaf hashes similar to D and AB is aTapBranch hash. Note that when CDE is computed E is hashed firstbecause E is less thanCD." title="This diagram shows the hashing structure to obtain the tweak from an internal key P and a Merkle tree consisting of 5 script leaves. A, B, C and E are TapLeaf hashes similar to D and AB is a TapBranch hash. Note that when CDE is computed E is hashed first because E is less than CD."></p> <p>To spend this output using script <em>D</em>, the control block would contain
the following data in this order:</p> <p><code>&lt;control byte with leaf version and parity bit&gt;</code> <code>&lt;internal key p&gt;</code> <code>&lt;C&gt;</code> <code>&lt;E&gt;</code> <code>&lt;AB&gt;</code></p> <p>The TapTweak would then be computed as described
<a href="bip-0341.mediawiki#script-validation-rules" title="wikilink">above</a> like so:</p> <div class="language- extra-class"><pre><code>D = tagged_hash(&quot;TapLeaf&quot;, bytes([leaf_version]) + ser_script(script))
CD = tagged_hash(&quot;TapBranch&quot;, C + D)
CDE = tagged_hash(&quot;TapBranch&quot;, E + CD)
ABCDE = tagged_hash(&quot;TapBranch&quot;, AB + CDE)
TapTweak = tagged_hash(&quot;TapTweak&quot;, p + ABCDE)
</code></pre></div><p><strong>Spending using the key path</strong> A Taproot output can be spent with the
secret key corresponding to the <code>internal_pubkey</code>. To do so, a witness
stack consists of a single element: a
<a href="bip-0340.mediawiki" title="wikilink">BIP340</a> signature on the signature hash
as defined above, with the secret key tweaked by the same <code>h</code> as in the
above snippet. See the code below:</p> <div class="language-{.python} line-numbers-mode"><pre class="language-text"><code>def taproot_sign_key(script_tree, internal_seckey, hash_type):
    _, h = taproot_tree_helper(script_tree)
    output_seckey = taproot_tweak_seckey(internal_seckey, h)
    sig = schnorr_sign(sighash(hash_type), output_seckey)
    if hash_type != 0:
        sig += bytes([hash_type])
    return [sig]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This function returns the witness stack necessary and a <code>sighash</code>
function to compute the signature hash as defined above (for simplicity,
the snippet above ignores passing information like the transaction, the
input position, ... to the sighashing code).</p> <p><strong>Spending using one of the scripts</strong> A Taproot output can be spent by
satisfying any of the scripts used in its construction. To do so, a
witness stack consisting of the script's inputs, plus the script itself
and the control block are necessary. See the code below:</p> <div class="language-{.python} line-numbers-mode"><pre class="language-text"><code>def taproot_sign_script(internal_pubkey, script_tree, script_num, inputs):
    info, h = taproot_tree_helper(script_tree)
    (leaf_version, script), path = info[script_num]
    output_pubkey_y_parity, _ = taproot_tweak_pubkey(internal_pubkey, h)
    pubkey_data = bytes([output_pubkey_y_parity + leaf_version]) + internal_pubkey
    return inputs + [script, pubkey_data + path]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="security"><a href="#security" class="header-anchor">#</a> Security</h2> <p>Taproot improves the privacy of Bitcoin because instead of revealing all
possible conditions for spending an output, only the satisfied spending
condition has to be published. Ideally, outputs are spent using the key
path which prevents observers from learning the spending conditions of a
coin. A key path spend could be a &quot;normal&quot; payment from a single- or
multi-signature wallet or the cooperative settlement of hidden
multiparty contract.</p> <p>A script path spend leaks that there is a script path and that the key
path was not applicable - for example because the involved parties
failed to reach agreement. Moreover, the depth of a script in the Merkle
root leaks information including the minimum depth of the tree, which
suggests specific wallet software that created the output and helps
clustering. Therefore, the privacy of script spends can be improved by
deviating from the optimal tree determined by the probability
distribution over the leaves.</p> <p>Just like other existing output types, taproot outputs should never
reuse keys, for privacy reasons. This does not only apply to the
particular leaf that was used to spend an output but to all leaves
committed to in the output. If leaves were reused, it could happen that
spending a different output would reuse the same Merkle branches in the
Merkle proof. Using fresh keys implies that taproot output construction
does not need to take special measures to randomizing leaf positions
because they are already randomized due to the branch-sorting Merkle
tree construction used in taproot. This does not avoid leaking
information through the leaf depth and therefore only applies to
balanced (sub-) trees. In addition, every leaf should have a set of keys
distinct from every other leaf. The reason for this is to increase leaf
entropy and prevent an observer from learning an undisclosed script
using brute-force search.</p> <h2 id="test-vectors-test-vectors"><a href="#test-vectors-test-vectors" class="header-anchor">#</a> Test vectors {#test_vectors}</h2> <p>Examples with creation transaction and spending transaction pairs, valid
and invalid.</p> <p>Examples of preimage for sighashing for each of the sighash modes.</p> <h2 id="rationale"><a href="#rationale" class="header-anchor">#</a> Rationale</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;references /&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h2> <p>TODO</p> <h2 id="backwards-compatibility-backwards-compatibility"><a href="#backwards-compatibility-backwards-compatibility" class="header-anchor">#</a> Backwards compatibility {#backwards_compatibility}</h2> <p>As a soft fork, older software will continue to operate without
modification. Non-upgraded nodes, however, will consider all SegWit
version 1 witness programs as anyone-can-spend scripts. They are
strongly encouraged to upgrade in order to fully validate the new
programs.</p> <p>Non-upgraded wallets can receive and send bitcoin from non-upgraded and
upgraded wallets using SegWit version 0 programs, traditional
pay-to-pubkey-hash, etc. Depending on the implementation non-upgraded
wallets may be able to send to Segwit version 1 programs if they support
sending to <a href="bip-0173.mediawiki" title="wikilink">BIP173</a> Bech32 addresses.</p> <h2 id="acknowledgements"><a href="#acknowledgements" class="header-anchor">#</a> Acknowledgements</h2> <p>This document is the result of discussions around script and signature
improvements with many people, and had direct contributions from Greg
Maxwell and others. It further builds on top of earlier published
proposals such as Taproot by Greg Maxwell, and Merkle branch
constructions by Russell O'Connor, Johnson Lau, and Mark Friedenbach.</p> <p>The authors wish the thank Arik Sosman for suggesting to sort Merkle
node children before hashes, removing the need to transfer the position
in the tree, as well as all those who provided valuable feedback and
reviews, including the participants of the <a href="https://github.com/ajtowns/taproot-review" target="_blank" rel="noopener noreferrer">structured
reviews<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>[^1]: <strong>What does not adding security assumptions mean?</strong> Unforgeability
of signatures is a necessary requirement to prevent theft. At least
when treating script execution as a digital signature scheme itself,
unforgeability can be <a href="https://github.com/apoelstra/taproot" target="_blank" rel="noopener noreferrer">proven<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
in the Random Oracle Model assuming the Discrete Logarithm problem
is hard. A
<a href="https://nbn-resolving.de/urn:nbn:de:hbz:294-60803" target="_blank" rel="noopener noreferrer">proof<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for
unforgeability of ECDSA in the current script system needs
non-standard assumptions on top of that. Note that it is hard in
general to model exactly what security for script means, as it
depends on the policies and protocols used by wallet software.</p> <p>[^2]: <strong>Why is the public key directly included in the output?</strong> While
typical earlier constructions store a hash of a script or a public
key in the output, this is rather wasteful when a public key is
always involved. To guarantee batch verifiability, the public key
must be known to every verifier, and thus only revealing its hash as
an output would imply adding an additional 32 bytes to the witness.
Furthermore, to maintain <a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2016-January/012198.html" target="_blank" rel="noopener noreferrer">128-bit collision
security<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
for outputs, a 256-bit hash would be required anyway, which is
comparable in size (and thus in cost for senders) to revealing the
public key directly. While the usage of public key hashes is often
said to protect against ECDLP breaks or quantum computers, this
protection is very weak at best: transactions are not protected
while being confirmed, and a very <a href="https://twitter.com/pwuille/status/1108097835365339136" target="_blank" rel="noopener noreferrer">large
portion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of
the currency's supply is not under such protection regardless.
Actual resistance to such systems can be introduced by relying on
different cryptographic assumptions, but this proposal focuses on
improvements that do not change the security model.</p> <p>[^3]: <strong>Why is P2SH-wrapping not supported?</strong> Using P2SH-wrapped outputs
only provides 80-bit collision security due to the use of a 160-bit
hash. This is considered low, and becomes a security risk whenever
the output includes data from more than a single party (public keys,
hashes, ...).</p> <p>[^4]: <strong>Why is the first byte of the annex <code>0x50</code>?</strong> The <code>0x50</code> is
chosen as it could not be confused with a valid P2WPKH or P2WSH
spending. As the control block's initial byte's lowest bit is used
to indicate the parity of the public key's Y coordinate, each leaf
version needs an even byte value and the immediately following odd
byte value that are both not yet used in P2WPKH or P2WSH spending.
To indicate the annex, only an &quot;unpaired&quot; available byte is
necessary like <code>0x50</code>. This choice maximizes the available options
for future script versions.</p> <p>[^5]: <strong>What is the purpose of the annex?</strong> The annex is a reserved
space for future extensions, such as indicating the validation costs
of computationally expensive new opcodes in a way that is
recognizable without knowing the scriptPubKey of the output being
spent. Until the meaning of this field is defined by another
softfork, users SHOULD NOT include <code>annex</code> in transactions, or it
may lead to PERMANENT FUND LOSS.</p> <p>[^6]: <strong>Why is the Merkle path length limited to 128?</strong> The optimally
space-efficient Merkle tree can be constructed based on the
probabilities of the scripts in the leaves, using the Huffman
algorithm. This algorithm will construct branches with lengths
approximately equal to <em>log~2~(1/probability)</em>, but to have branches
longer than 128 you would need to have scripts with an execution
chance below 1 in <em>2^128^</em>. As that is our security bound, scripts
that truly have such a low chance can probably be removed entirely.</p> <p>[^7]: <strong>What constraints are there on the leaf version?</strong> First, the
leaf version cannot be odd as <em>c[0] &amp; 0xfe</em> will always be even,
and cannot be <em>0x50</em> as that would result in ambiguity with the
annex. In addition, in order to support some forms of static
analysis that rely on being able to identify script spends without
access to the output being spent, it is recommended to avoid using
any leaf versions that would conflict with a valid first byte of
either a valid P2WPKH pubkey or a valid P2WSH script (that is, both
<em>v</em> and <em>v | 1</em> should be an undefined, invalid or disabled opcode
or an opcode that is not valid as the first opcode). The values that
comply to this rule are the 32 even values between <em>0xc0</em> and <em>0xfe</em>
and also <em>0x66</em>, <em>0x7e</em>, <em>0x80</em>, <em>0x84</em>, <em>0x96</em>, <em>0x98</em>, <em>0xba</em>,
<em>0xbc</em>, <em>0xbe</em>. Note also that this constraint implies that leaf
versions should be shared amongst different witness versions, as
knowing the witness version requires access to the output being
spent.</p> <p>[^8]: <strong>Why are child elements sorted before hashing in the Merkle
tree?</strong> By doing so, it is not necessary to reveal the left/right
directions along with the hashes in revealed Merkle branches. This
is possible because we do not actually care about the position of
specific scripts in the tree; only that they are actually committed
to.</p> <p>[^9]: <strong>Why not use a more efficient hash construction for inner Merkle
nodes?</strong> The chosen construction does require two invocations of the
SHA256 compression functions, one of which can be avoided in theory
(see <a href="bip-0098.mediawiki" title="wikilink">BIP98</a>). However, it seems
preferable to stick to constructions that can be implemented using
standard cryptographic primitives, both for implementation
simplicity and analyzability. If necessary, a significant part of
the second compression function can be optimized out by
<a href="https://github.com/bitcoin/bitcoin/pull/13191" target="_blank" rel="noopener noreferrer">specialization<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for
64-byte inputs.</p> <p>[^10]: <strong>Why is it necessary to reveal a bit in a script path spend and
check that it matches the parity of the Y coordinate of <em>Q</em>?</strong> The
parity of the Y coordinate is necessary to lift the X coordinate <em>q</em>
to a unique point. While this is not strictly necessary for
verifying the taproot commitment as described above, it is necessary
to allow batch verification. Alternatively, <em>Q</em> could be forced to
have an even Y coordinate, but that would require retrying with
different internal public keys (or different messages) until <em>Q</em> has
that property. There is no downside to adding the parity bit because
otherwise the control block bit would be unused.</p> <p>[^11]: <strong>What are the applicable script rules in script path spends?</strong> <a href="bip-0342.mediawiki" title="wikilink">BIP342</a> specifies validity rules
that apply for leaf version 0xc0, but future proposals can introduce
rules for other leaf versions.</p> <p>[^12]: <strong>Why reject unknown <em>hash_type</em> values?</strong> By doing so, it is
easier to reason about the worst case amount of signature hashing an
implementation with adequate caching must perform.</p> <p>[^13]: <strong>What extensions use the <em>ext_flag</em> mechanism?</strong> <a href="bip-0342.mediawiki" title="wikilink">BIP342</a> reuses the same common
signature message algorithm, but adds BIP342-specific data at the
end, which is indicated using <em>ext_flag = 1</em>.</p> <p>[^14]: <strong>What is the output length of <em>SigMsg()</em>?</strong> The total length of
<em>SigMsg()</em> can be computed using the following formula: <em>174 -
is_anyonecanpay * 49 - is_none * 32 + has_annex * 32</em>.</p> <p>[^15]: <strong>Why is the serialization in the signature message changed?</strong>
Hashes that go into the signature message and the message itself are
now computed with a single SHA256 invocation instead of double
SHA256. There is no expected security improvement by doubling SHA256
because this only protects against length-extension attacks against
SHA256 which are not a concern for signature messages because there
is no secret data. Therefore doubling SHA256 is a waste of
resources. The message computation now follows a logical order with
transaction level data first, then input data and output data. This
allows to efficiently cache the transaction part of the message
across different inputs using the SHA256 midstate. Additionally,
sub-hashes can be skipped when calculating the message (for example
`sha_prevouts` if <code>SIGHASH_ANYONECANPAY</code> is set) instead of
setting them to zero and then hashing them as in BIP143. Despite
that, collisions are made impossible by committing to the length of
the data (implicit in <em>hash_type</em> and <em>spend_type</em>) before the
variable length data.</p> <p>[^16]: <strong>Why does the signature message commit to the <em>scriptPubKey</em>?</strong>
This prevents lying to offline signing devices about output being
spent, even when the actually executed script (<em>scriptCode</em> in
BIP143) is correct. This means it's possible to compactly prove to
a hardware wallet what (unused) execution paths existed. Moreover,
committing to all spent <em>scriptPubKey</em>s helps offline signing
devices to determine the subset that belong to its own wallet. This
is useful in <a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2020-April/017801.html" target="_blank" rel="noopener noreferrer">automated
coinjoins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>[^17]: <strong>Why does the signature message commit to the amounts of all
transaction inputs?</strong> This eliminates the possibility to lie to
offline signing devices about the fee of a transaction.</p> <p>[^18]: <strong>Why does the signature message commit to all input <em>nSequence</em>
if <code>SIGHASH_SINGLE</code> or <code>SIGHASH_NONE</code> are set?</strong> Because setting
them already makes the message commit to the <code>prevouts</code> part of all
transaction inputs, it is not useful to treat the <em>nSequence</em> any
different. Moreover, this change makes <em>nSequence</em> consistent with
the view that <code>SIGHASH_SINGLE</code> and <code>SIGHASH_NONE</code> only modify the
signature message with respect to transaction outputs and not
inputs.</p> <p>[^19]: <strong>Why is the input to <em>hash~TapSighash~</em> prefixed with 0x00?</strong>
This prefix is called the sighash epoch, and allows reusing the
<em>hash~TapSighash~</em> tagged hash in future signature algorithms that
make invasive changes to how hashing is performed (as opposed to the
<em>ext_flag</em> mechanism that is used for incremental extensions). An
alternative is having them use a different tag, but supporting a
growing number of tags may become undesirable.</p> <p>[^20]: <strong>Why can the <code>hash_type</code> not be <code>0x00</code> in 65-byte signatures?</strong>
Permitting that would enable malleating (by third parties, including
miners) 64-byte signatures into 65-byte ones, resulting in a
different `wtxid` and a different fee rate than the creator
intended</p> <p>[^21]: <strong>Why permit two signature lengths?</strong> By making the most common
type of <code>hash_type</code> implicit, a byte can often be saved.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bitcoindocs/bips/340.html" class="prev">
        340
      </a></span> <span class="next"><a href="/bitcoindocs/bips/342.html">
        342
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/bitcoindocs/assets/js/app.c31d8641.js" defer></script><script src="/bitcoindocs/assets/js/2.b78a9106.js" defer></script><script src="/bitcoindocs/assets/js/87.a547f760.js" defer></script>
  </body>
</html>
