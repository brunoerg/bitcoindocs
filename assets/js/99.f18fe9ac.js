(window.webpackJsonp=window.webpackJsonp||[]).push([[99],{474:function(e,t,n){"use strict";n.r(t);var s=n(43),a=Object(s.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"_62"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_62"}},[e._v("#")]),e._v(" 62")]),e._v(" "),n("p",[n("strong",[e._v("NOTICE: This document is a work in progress and is not complete,\nimplemented, or otherwise suitable for deployment.")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[e._v("  BIP: 62\n  Layer: Consensus (soft fork)\n  Title: Dealing with malleability\n  Author: Pieter Wuille <pieter.wuille@gmail.com>\n  Comments-Summary: No comments yet.\n  Comments-URI: https://github.com/bitcoin/bips/wiki/Comments:BIP-0062\n  Status: Withdrawn\n  Type: Standards Track\n  Created: 2014-03-12\n  License: BSD-2-Clause\n")])])]),n("h2",{attrs:{id:"abstract"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#abstract"}},[e._v("#")]),e._v(" Abstract")]),e._v(" "),n("p",[e._v("This document specifies proposed changes to the Bitcoin transaction\nvalidity rules in order to make malleability of transactions impossible\n(at least when the sender doesn't choose to avoid it).")]),e._v(" "),n("h2",{attrs:{id:"copyright"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#copyright"}},[e._v("#")]),e._v(" Copyright")]),e._v(" "),n("p",[e._v("This BIP is licensed under the 2-clause BSD license.")]),e._v(" "),n("h2",{attrs:{id:"motivation"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#motivation"}},[e._v("#")]),e._v(" Motivation")]),e._v(" "),n("p",[e._v("As of february 2014, Bitcoin transactions are malleable in multiple\nways. This means a (valid) transaction can be modified in-flight,\nwithout invalidating it, but without access to the relevant private\nkeys.")]),e._v(" "),n("p",[e._v("This is a problem for multiple reasons:")]),e._v(" "),n("ul",[n("li",[e._v("The sender may not recognize his own transaction after being\nmodified.")]),e._v(" "),n("li",[e._v("The sender may create transactions that spend change created by the\noriginal transaction. In case the modified transaction gets mined,\nthis becomes invalid.")]),e._v(" "),n("li",[e._v("Modified transactions are effectively double-spends which can be\ncreated without malicious intent (of the sender), but can be used to\nmake other attacks easier.")])]),e._v(" "),n("p",[e._v("Several sources of malleability are known:")]),e._v(" "),n("ol",[n("li",[n("strong",[e._v("Non-DER encoded ECDSA signatures")]),e._v(" Right now, the Bitcoin\nreference client uses OpenSSL to validate signatures. As OpenSSL\naccepts more than serializations that strictly adhere to the DER\nstandard, this is a source of malleability. Since v0.8.0, non-DER\nsignatures are no longer relayed already.")]),e._v(" "),n("li",[n("strong",[e._v("Non-push operations in scriptSig")]),e._v(" Any sequence of script\noperations in scriptSig that results in the intended data pushes,\nbut is not just a push of that data, results in an alternative\ntransaction with the same validity.")]),e._v(" "),n("li",[n("strong",[e._v("Push operations in scriptSig of non-standard size type")]),e._v(" The\nBitcoin scripting language has several push operators (OP_0,\nsingle-byte pushes, data pushes of up to 75 bytes, OP_PUSHDATA1,\nOP_PUSHDATA2, OP_PUSHDATA4). As the later ones have the same result\nas the former ones, they result in additional possibilities.")]),e._v(" "),n("li",[n("strong",[e._v("Zero-padded number pushes")]),e._v(" In cases where scriptPubKey opcodes\nuse inputs that are interpreted as numbers, they can be zero padded.")]),e._v(" "),n("li",[n("strong",[e._v("Inherent ECDSA signature malleability")]),e._v(" ECDSA signatures\nthemselves are already malleable: taking the negative of the number\nS inside (modulo the curve order) does not invalidate it.")]),e._v(" "),n("li",[n("strong",[e._v("Superfluous scriptSig operations")]),e._v(" Adding extra data pushes at the\nstart of scripts, which are not consumed by the corresponding\nscriptPubKey, is also a source of malleability.")]),e._v(" "),n("li",[n("strong",[e._v("Inputs ignored by scripts")]),e._v(" If a scriptPubKey starts with an\nOP_DROP, for example, the last data push of the corresponding\nscriptSig will always be ignored.")]),e._v(" "),n("li",[n("strong",[e._v("Sighash flags based masking")]),e._v(" Sighash flags can be used to ignore\ncertain parts of a script when signing.")]),e._v(" "),n("li",[n("strong",[e._v("New signatures by the sender")]),e._v(" The sender (or anyone with access\nto the relevant private keys) is always able to create new\nsignatures that spend the same inputs to the same outputs.")])]),e._v(" "),n("p",[e._v("The first six and part of the seventh can be fixed by extra consensus\nrules, but the last two can't. Not being able to fix #7 means that\neven with these new consensus rules, it will always be possible to\ncreate outputs whose spending transactions will all be malleable.\nHowever, when restricted to using a safe set of output scripts, extra\nconsensus rules can make spending transactions optionally non-malleable\n(if the spender chooses to; as he can always bypass #8 and #9\nhimself).")]),e._v(" "),n("h2",{attrs:{id:"specification"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#specification"}},[e._v("#")]),e._v(" Specification")]),e._v(" "),n("h3",{attrs:{id:"new-rules-new-rules"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#new-rules-new-rules"}},[e._v("#")]),e._v(" New rules {#new_rules}")]),e._v(" "),n("p",[e._v("Seven extra rules are introduced, to combat exactly the seven first\nsources of malleability listed above:")]),e._v(" "),n("ol",[n("li",[n("strong",[e._v("Canonically encoded ECDSA signatures")]),e._v(" An ECDSA signature passed\nto OP_CHECKSIG, OP_CHECKSIGVERIFY, OP_CHECKMULTISIG or\nOP_CHECKMULTISIGVERIFY must be encoded using strict DER encoding. To\nprovide a compact way to deliberately create an invalid signature\nfor OP_CHECKSIG and OP_CHECKMULTISIG, an empty byte array (i.e., the\nresult of OP_0) is also allowed. Doing a verification with a non-DER\nsignature makes the entire script evaluate to False (not just the\nsignature verification). See reference: "),n("a",{attrs:{href:"#der-encoding",title:"wikilink"}},[e._v("DER\nencoding")]),e._v(".")]),e._v(" "),n("li",[n("strong",[e._v("Non-push operations in scriptSig")]),e._v(" Only data pushes are allowed in\nscriptSig. Evaluating any other operation makes the script evaluate\nto false. See reference: "),n("a",{attrs:{href:"#push-operators",title:"wikilink"}},[e._v("Push\noperators")]),e._v(".")]),e._v(" "),n("li",[n("strong",[e._v("Push operations in scriptSig of non-standard size type")]),e._v(" The\nsmallest possible push operation must be used when possible. Pushing\ndata using an operation that could be encoded in a shorter way makes\nthe script evaluate to false. See reference: "),n("a",{attrs:{href:"#push-operators",title:"wikilink"}},[e._v("Push\noperators")]),e._v(".")]),e._v(" "),n("li",[n("strong",[e._v("Zero-padded number pushes")]),e._v(" Any time a script opcode consumes a\nstack value that is interpreted as a number, it must be encoded in\nits shortest possible form. 'Negative zero' is not allowed. See\nreference: "),n("a",{attrs:{href:"#numbers",title:"wikilink"}},[e._v("Numbers")]),e._v(".")]),e._v(" "),n("li",[n("strong",[e._v("Inherent ECDSA signature malleability")]),e._v(" We require that the S\nvalue inside ECDSA signatures is at most the curve order divided by\n2 (essentially restricting this value to its lower half range). See\nreference: "),n("a",{attrs:{href:"#low-s-values-in-signatures",title:"wikilink"}},[e._v("Low S values in\nsignatures")]),e._v(".")]),e._v(" "),n("li",[n("strong",[e._v("Superfluous scriptSig operations")]),e._v(" scriptPubKey evaluation will be\nrequired to result in a single non-zero value. If any extra data\nelements remain on the stack, the script evaluates to false.")]),e._v(" "),n("li",[n("strong",[e._v("Inputs ignored by scripts")]),e._v(" The (unnecessary) extra stack element\nconsumed by OP_CHECKMULTISIG and OP_CHECKMULTISIGVERIFY must be the\nempty byte array (the result of OP_0). Anything else makes the\nscript evaluate to false.")])]),e._v(" "),n("h3",{attrs:{id:"block-validity-block-validity"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#block-validity-block-validity"}},[e._v("#")]),e._v(" Block validity {#block_validity}")]),e._v(" "),n("p",[e._v("To introduce these new rules in the network, we add both v3 blocks and\nv3 transactions. v2 is skipped for transactions to keep the version\nnumbers between transaction and block rules in sync. v2 transactions are\ntreated identically to v1 transactions. The same mechanism as in BIP\n0034 is used to introduce v3 blocks. When 75% of the past 1000 blocks\nare v3, a new consensus rule is activated:")]),e._v(" "),n("ul",[n("li",[e._v("All transactions in v3 blocks are required to follow rules #1-#2.")]),e._v(" "),n("li",[e._v("v3 (and higher) transactions in v3 blocks are required to follow\nrules #3-#7 as well.")])]),e._v(" "),n("p",[e._v("When 95% of the past 1000 blocks are v3 or higher, v2 blocks become\ninvalid entirely. Note however that v1 (and v2) transactions remain\nvalid forever.")]),e._v(" "),n("h3",{attrs:{id:"references"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),n("p",[e._v("Below is a summary of the effects on signatures, their encoding and data\npushes.")]),e._v(" "),n("h4",{attrs:{id:"low-s-values-in-signatures-low-s-values-in-signatures"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#low-s-values-in-signatures-low-s-values-in-signatures"}},[e._v("#")]),e._v(" Low S values in signatures {#low_s_values_in_signatures}")]),e._v(" "),n("p",[e._v("The value S in signatures must be between 0x1 and 0x7FFFFFFF FFFFFFFF\nFFFFFFFF FFFFFFFF 5D576E73 57A4501D DFE92F46 681B20A0 (inclusive). If S\nis too high, simply replace it by S' = 0xFFFFFFFF FFFFFFFF FFFFFFFF\nFFFFFFFE BAAEDCE6 AF48A03B BFD25E8C D0364141 - S.")]),e._v(" "),n("p",[e._v("Signatures produced by the OpenSSL library are not guaranteed to be\nconsistent with this constraint. Version 0.9.3 of the reference client\nprovides "),n("a",{attrs:{href:"https://github.com/bitcoin/bitcoin/blob/v0.9.3/src/key.cpp#L202-L227",target:"_blank",rel:"noopener noreferrer"}},[e._v("an\nexample"),n("OutboundLink")],1),e._v("\nfor detection and correction.")]),e._v(" "),n("p",[e._v("The constraints on the value R are unchanged w.r.t. ECDSA, and values\ncan be between 0x1 and 0xFFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFE BAAEDCE6\nAF48A03B BFD25E8C D0364140 (inclusive).")]),e._v(" "),n("h4",{attrs:{id:"der-encoding-der-encoding"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#der-encoding-der-encoding"}},[e._v("#")]),e._v(" DER encoding {#der_encoding}")]),e._v(" "),n("p",[e._v("For reference, here is how to encode signatures correctly in DER format.")]),e._v(" "),n("p",[e._v("0x30 [total-length] 0x02 [R-length] [R] 0x02 [S-length] [S]\n[sighash-type]")]),e._v(" "),n("ul",[n("li",[e._v("total-length: 1-byte length descriptor of everything that follows,\nexcluding the sighash byte.")]),e._v(" "),n("li",[e._v("R-length: 1-byte length descriptor of the R value that follows.")]),e._v(" "),n("li",[e._v("R: arbitrary-length big-endian encoded R value. It cannot start with\nany 0x00 bytes, unless the first byte that follows is 0x80 or\nhigher, in which case a single 0x00 is required.")]),e._v(" "),n("li",[e._v("S-length: 1-byte length descriptor of the S value that follows.")]),e._v(" "),n("li",[e._v("S: arbitrary-length big-endian encoded S value. The same rules apply\nas for R.")]),e._v(" "),n("li",[e._v("sighash-type: 1-byte hashtype flag (only 0x01, 0x02, 0x03, 0x81,\n0x82 and 0x83 are allowed).")])]),e._v(" "),n("p",[e._v("This is already enforced by the reference client as of version 0.8.0\n(only as relay policy, not as a consensus rule).")]),e._v(" "),n("p",[e._v("This rule, combined with the low S requirement above, results in\nS-length being at most 32 (and R-length at most 33), and the total\nsignature size being at most 72 bytes (and on average 71.494 bytes).")]),e._v(" "),n("h4",{attrs:{id:"push-operators-push-operators"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#push-operators-push-operators"}},[e._v("#")]),e._v(" Push operators {#push_operators}")]),e._v(" "),n("ul",[n("li",[e._v("Pushing an empty byte sequence must use OP_0.")]),e._v(" "),n("li",[e._v("Pushing a 1-byte sequence of byte 0x01 through 0x10 must use OP_n.")]),e._v(" "),n("li",[e._v("Pushing the byte 0x81 must use OP_1NEGATE.")]),e._v(" "),n("li",[e._v("Pushing any other byte sequence up to 75 bytes must use the normal\ndata push (opcode byte n, with n the number of bytes, followed n\nbytes of data being pushed).")]),e._v(" "),n("li",[e._v("Pushing 76 to 255 bytes must use OP_PUSHDATA1.")]),e._v(" "),n("li",[e._v("Pushing 256 to 520 bytes must use OP_PUSHDATA2.")]),e._v(" "),n("li",[e._v("OP_PUSHDATA4 can never be used, as pushes over 520 bytes are not\nallowed, and those below can be done using other operators.")]),e._v(" "),n("li",[e._v("Any other operation is not considered to be a push.")])]),e._v(" "),n("h4",{attrs:{id:"numbers"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#numbers"}},[e._v("#")]),e._v(" Numbers")]),e._v(" "),n("p",[e._v("The native data type of stack elements is byte arrays, but some\noperations interpret arguments as integers. The used encoding is little\nendian with an explicit sign bit (the highest bit of the last byte). The\nshortest encodings for numbers are (with the range boundaries encodings\ngiven in hex between ()).")]),e._v(" "),n("ul",[n("li",[e._v("0: OP_0; (00)")]),e._v(" "),n("li",[e._v("1..16: OP_1..OP_16; (51)..(60)")]),e._v(" "),n("li",[e._v("-1: OP_1NEGATE; (79)")]),e._v(" "),n("li",[e._v("-127..-2 and 17..127: normal 1-byte data push; (01 FF)..(01 82) and\n(01 11)..(01 7F)")]),e._v(" "),n("li",[e._v("-32767..-128 and 128..32767: normal 2-byte data push; (02 FF\nFF)..(02 80 80) and (02 80 00)..(02 FF 7F)")]),e._v(" "),n("li",[e._v("-8388607..-32768 and 32768..8388607: normal 3-byte data push; (03 FF\nFF FF)..(03 00 80 80) and (03 00 80 00)..(03 FF FF 7F)")]),e._v(" "),n("li",[e._v("-2147483647..-8388608 and 8388608..2147483647: normal 4-byte data\npush; (04 FF FF FF FF)..(04 00 00 80 80) and (04 00 00 80 00)..(04\nFF FF FF 7F)")]),e._v(" "),n("li",[e._v("Any other numbers cannot be encoded.")])]),e._v(" "),n("p",[e._v("In particular, note that zero could be encoded as (01 80) (negative\nzero) if using the non-shortest form is allowed.")]),e._v(" "),n("h2",{attrs:{id:"compatibility"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#compatibility"}},[e._v("#")]),e._v(" Compatibility")]),e._v(" "),n("p",[n("strong",[e._v("Relay of transactions")]),e._v(" A new node software version is released which\nmakes v3 transactions standard, and relays them when their scriptSigs\nsatisfy the above rules. Relaying of v1 transactions is unaffected. A v1\ntransaction spending an output created by a v3 transaction is also\nunaffected.")]),e._v(" "),n("p",[n("strong",[e._v("Wallet updates")]),e._v(' As v3 transactions are non-standard currently, it is\nnot possible to start creating them immediately. Software can be checked\nto confirm to the new rules of course, but using v3 should only start\nwhen a significant part of the network\'s nodes has upgraded to\ncompatible code. Its intended meaning is "I want this transaction\nprotected from malleability", and remains a choice of the wallet\nsoftware.')])])}),[],!1,null,null,null);t.default=a.exports}}]);