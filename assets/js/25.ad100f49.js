(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{401:function(t,s,a){"use strict";a.r(s);var n=a(43),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_114"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_114"}},[t._v("#")]),t._v(" 114")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[t._v("  BIP: 114\n  Layer: Consensus (soft fork)\n  Title: Merkelized Abstract Syntax Tree\n  Author: Johnson Lau <jl2012@xbt.hk>\n  Comments-Summary: No comments yet.\n  Comments-URI: https://github.com/bitcoin/bips/wiki/Comments:BIP-0114\n  Status: Rejected\n  Type: Standards Track\n  Created: 2016-04-02\n  License: PD\n")])])]),a("h2",{attrs:{id:"abstract"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#abstract"}},[t._v("#")]),t._v(" Abstract")]),t._v(" "),a("p",[t._v("This BIP defines a new witness program type that uses a Merkle tree to\nencode mutually exclusive branches in a script. This enables complicated\nredemption conditions that are currently not possible, improves privacy\nby hiding unexecuted scripts, and allows inclusion of non-consensus\nenforced data with very low or no additional cost.")]),t._v(" "),a("h2",{attrs:{id:"motivation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#motivation"}},[t._v("#")]),t._v(" Motivation")]),t._v(" "),a("h3",{attrs:{id:"evolution-of-bitcoin-script-system-evolution-of-bitcoin-script-system"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#evolution-of-bitcoin-script-system-evolution-of-bitcoin-script-system"}},[t._v("#")]),t._v(" Evolution of Bitcoin script system {#evolution_of_bitcoin_script_system}")]),t._v(" "),a("p",[t._v("Bitcoin uses a script system to specify the conditions for redemption of\ntransaction outputs. In its original design, the conditions for\nredemption are directly recorded in the scriptPubKey by the sender of\nthe funds. This model has several drawbacks, particularly for\ncomplicated scripts:")]),t._v(" "),a("ol",[a("li",[t._v("It could be difficult for the receiver to specify the conditions;")]),t._v(" "),a("li",[t._v("Large scripts take up more UTXO space;")]),t._v(" "),a("li",[t._v("The sender will pay for the additional block space;")]),t._v(" "),a("li",[t._v("To prevent DoS attack, scripts are limited to 10,000 bytes and 201\nop codes;")]),t._v(" "),a("li",[t._v("Any unexecuted branches and non-consensus enforced data in the\nscript are visible to the public, consuming block space while\ndamaging privacy.")])]),t._v(" "),a("p",[t._v("The "),a("a",{attrs:{href:"bip-0016.mediawiki",title:"wikilink"}},[t._v("BIP16")]),t._v(' (Pay-to-script-hash,\n"P2SH") fixes the first 3 problems by using a fixed-length 20-byte\nscript hash in the scriptPubKey, and moving the responsibility for\nsupplying the script to the redeemer. However, due to the data push size\nlimit in script, a P2SH script may not be bigger than 520 bytes. Also,\nP2SH still requires the redeemer to publish all unexecuted branches of\nthe script.')]),t._v(" "),a("p",[t._v("The "),a("a",{attrs:{href:"bip-0141.mediawiki",title:"wikilink"}},[t._v("BIP141")]),t._v(" defines 2 new types of\nscripts that support segregated witness. The pay-to-witness-script-hash\n(P2WSH) is similar to P2SH is many ways. By supplying the script in\nwitness, P2WSH restores the original 10,000 byte script limit. However,\nit still requires publishing of unexecuted branches.")]),t._v(" "),a("h3",{attrs:{id:"merkelized-abstract-syntax-tree-merkelized-abstract-syntax-tree"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#merkelized-abstract-syntax-tree-merkelized-abstract-syntax-tree"}},[t._v("#")]),t._v(" Merkelized Abstract Syntax Tree {#merkelized_abstract_syntax_tree}")]),t._v(" "),a("p",[t._v("The idea of Merkelized Abstract Syntax Tree (MAST) is to use a Merkle\ntree to encode branches in a script. When spending, users may provide\nonly the branches they are executing, and hashes that connect the\nbranches to the fixed size Merkel root. This reduces the size of\nredemption stack from O(n) to O(log n) (n as the number of branches).\nThis enables complicated redemption conditions that is currently not\npossible due to the script size and opcode limit, improves privacy by\nhiding unexecuted branches, and allows inclusion of non-consensus\nenforced data with very low or no additional cost.")]),t._v(" "),a("h2",{attrs:{id:"specification"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#specification"}},[t._v("#")]),t._v(" Specification")]),t._v(" "),a("p",[t._v("In "),a("a",{attrs:{href:"bip-0141.mediawiki",title:"wikilink"}},[t._v("BIP141")]),t._v(", witness programs with a\nversion byte of 1 or larger are considered to be anyone-can-spend\nscripts. The following new validation rules are applied if the witness\nprogram version byte is 1 and the program size is 32 bytes.[^1] The\nwitness program is the "),a("code",[t._v("MAST Root")]),t._v(".")]),t._v(" "),a("p",[t._v("To redeem an output of this kind, the witness must consist of the\nfollowing items:")]),t._v(" "),a("p",[a("code",[t._v("Script_stack_1")]),a("br"),t._v(" "),a("code",[t._v("Script_stack_2")]),a("br"),t._v(" "),a("code",[t._v(".")]),a("br"),t._v(" "),a("code",[t._v(".")]),a("br"),t._v(" "),a("code",[t._v("Script_stack_X (X ≥ 0)")]),a("br"),t._v(" "),a("code",[t._v("Subscript_1")]),a("br"),t._v(" "),a("code",[t._v("Subscript_2")]),a("br"),t._v(" "),a("code",[t._v(".")]),a("br"),t._v(" "),a("code",[t._v(".")]),a("br"),t._v(" "),a("code",[t._v("Subscript_Y (1 ≤ Y ≤ 255)")]),a("br"),t._v(" "),a("code",[t._v("Position")]),a("br"),t._v(" "),a("code",[t._v("Path")]),a("br"),t._v(" "),a("code",[t._v("Metadata (Y|MAST Version)")])]),t._v(" "),a("p",[a("code",[t._v("Metadata")]),t._v(" is the last witness item. It is a vector of 1 to 5 bytes. The\nfirst byte is an unsigned integer between 1 to 255 denoting the number\nof "),a("code",[t._v("Subscript")]),t._v(" (defined hereinafter). The following 0 to 4 byte(s) is an\nunsigned little-endian integer denoting the "),a("code",[t._v("MAST version")]),t._v(".\n"),a("code",[t._v("MAST Version")]),t._v(" must be minimally encoded (the most significant byte must\nnot be 0).")]),t._v(" "),a("p",[a("code",[t._v("Path")]),t._v(" is the second last witness item. It is a serialized Merkle path\nof the "),a("code",[t._v("Script Hash")]),t._v(" (defined hereinafter). Size of "),a("code",[t._v("Path")]),t._v(" must be a\nmultiple of 32 bytes, and not more than 1024 bytes. Each 32 byte word is\na double-SHA256 merkle node in the merkle branch connecting to the\n"),a("code",[t._v("Script Root")]),t._v(" (defined hereinafter). "),a("code",[t._v("Depth")]),t._v(" of the tree (0 to 32) is\nthe size of "),a("code",[t._v("Path")]),t._v(" divided by 32.")]),t._v(" "),a("p",[a("code",[t._v("Position")]),t._v(" is the third last witness item. It indicates the location of\nthe "),a("code",[t._v("Script Hash")]),t._v(" in the Merkle tree, with zero indicating the leftmost\nposition. It is an unsigned little-endian integer with not more than 4\nbytes. It must be minimally encoded: the value must not be larger than\nthe maximum number of items allowed by the "),a("code",[t._v("Depth")]),t._v(" of the tree, and the\nmost significant byte must not be 0. For example, if "),a("code",[t._v("Depth")]),t._v(" is 4, the\nvalid range of "),a("code",[t._v("Position")]),t._v(" is 0 to 15 (2^4^-1).")]),t._v(" "),a("p",[t._v("Depends on the first byte of "),a("code",[t._v("Metadata")]),t._v(", there should be 1 to 255\n"),a("code",[t._v("Subscript")]),t._v(" witness item(s) before "),a("code",[t._v("Position")]),t._v(".")]),t._v(" "),a("p",[a("code",[t._v("Script Hash")]),t._v(" is defined as:")]),t._v(" "),a("p",[a("code",[t._v("Script Hash = H(Y|H(Subscript_1)|H(Subscript_2)|...|H(Subscript_Y))")]),a("br"),t._v(" "),a("code",[t._v("H() = SHA256(SHA256())")])]),t._v(" "),a("p",[t._v("where "),a("code",[t._v("Y")]),t._v(" is a 1-byte value denoting number of "),a("code",[t._v("Subscript")]),t._v(", followed by\nthe hash of each "),a("code",[t._v("Subscript")])]),t._v(" "),a("p",[a("code",[t._v("Script Root")]),t._v(" is the Merkle root calculated by the\n"),a("code",[t._v("ComputeMerkleRootFromBranch")]),t._v(" function, using "),a("code",[t._v("Script Hash")]),t._v(", "),a("code",[t._v("Path")]),t._v(" and\n"),a("code",[t._v("Position")]),t._v(".")]),t._v(" "),a("p",[a("code",[t._v("MAST Root")]),t._v(" is "),a("code",[t._v("H(MAST Version|Script Root)")]),t._v(". The pre-image has a fixed\nsize of 36 bytes: 4 bytes for "),a("code",[t._v("MAST Version")]),t._v(" (unsigned little-endian\ninteger) and 32 bytes for "),a("code",[t._v("Script Root")]),t._v(".")]),t._v(" "),a("p",[t._v("The script evaluation fails if "),a("code",[t._v("MAST Root")]),t._v(" does not match the witness\nprogram.")]),t._v(" "),a("p",[t._v("If the "),a("code",[t._v("MAST Root")]),t._v(" matches the witness program and "),a("code",[t._v("MAST Version")]),t._v(" is\ngreater than 0, the script returns a success without further evaluation.\n"),a("code",[t._v("SigOpsCost")]),t._v(" is counted as 0. This is reserved for future script\nupgrades.")]),t._v(" "),a("p",[t._v("If the "),a("code",[t._v("MAST Version")]),t._v(" is 0, the "),a("code",[t._v("Subscript")]),t._v("(s) are serialized to form\nthe final "),a("code",[t._v("MAST Script")]),t._v(", beginning with\n"),a("code",[t._v("</code>")]),t._v(" Subscript_1"),a("code",[t._v("</code>")]),t._v(" . The unused witness item(s)\nbefore the "),a("code",[t._v("</code>")]),t._v(" Subscript_1"),a("code",[t._v("</code>")]),t._v("  are used as\n"),a("code",[t._v("Input Stack")]),t._v(" to feed to the "),a("code",[t._v("MASTScript")]),t._v(". (Similar to P2WSH in BIP141)")]),t._v(" "),a("p",[t._v("The script fails with one of the following conditions:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("MAST Script")]),t._v(" is malformed (i.e. not enough data provided for the\nlast push operation). Individual "),a("code",[t._v("Subscript")]),t._v(" might be malformed, as\nlong as they are serialized into a valid "),a("code",[t._v("MAST Script")])]),t._v(" "),a("li",[t._v("Size of "),a("code",[t._v("MAST Script")]),t._v(" is larger than 10,000 bytes")]),t._v(" "),a("li",[t._v("Size of any one of the "),a("code",[t._v("Input Stack")]),t._v(" item is larger than 520 bytes")]),t._v(" "),a("li",[t._v("Number of non-push operations ("),a("code",[t._v("nOpCount")]),t._v(") is more than 201.\n"),a("code",[t._v("nOpCount")]),t._v(" is the sum of the number of non-push operations in\n"),a("code",[t._v("MAST Script")]),t._v(" (counted in the same way as P2WSH "),a("code",[t._v("witnessScript")]),t._v("),\nnumber of "),a("code",[t._v("Subscript")]),t._v(" (Y), and "),a("code",[t._v("Depth")]),t._v(" of the Merkle tree.")])]),t._v(" "),a("p",[t._v("The "),a("code",[t._v("MAST Script")]),t._v(" is then evaluated with the "),a("code",[t._v("Input Stack")]),t._v(" (with some\nnew or redefined opcodes described in BIPXXX). The evaluation must not\nfail, and result in an exactly empty stack.")]),t._v(" "),a("p",[t._v("Counting of "),a("code",[t._v("SigOpsCost")]),t._v(" is based on the "),a("code",[t._v("MAST Script")]),t._v(", described in\nBIPYYY.")]),t._v(" "),a("h2",{attrs:{id:"rationale"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rationale"}},[t._v("#")]),t._v(" Rationale")]),t._v(" "),a("h3",{attrs:{id:"mast-structure-mast-structure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mast-structure-mast-structure"}},[t._v("#")]),t._v(" MAST Structure {#mast_structure}")]),t._v(" "),a("p",[t._v("This proposal is a restricted case of more general MAST. In a general\nMAST design, users may freely assign one or more script branches for\nexecution. In this proposal, only one branch is allowed for execution,\nand users are required to transform a complicated condition into several\nmutually exclusive branches. For example, if the desired redeem\ncondition is:")]),t._v(" "),a("p",[a("code",[t._v("(A or B) and (C or D or E) and (F or G)")])]),t._v(" "),a("p",[t._v('In a general MAST design, the 7 branches (A to G) will form a 3-level\nMerkle tree, plus an "overall condition" describing the relationship\nof different branches. In redemption, the "overall condition",\nexecuted branches (e.g. B, D, F), and Merkle path data will be provided\nfor validation.')]),t._v(" "),a("p",[t._v("In the current proposal, the user has to transform the redeem condition\ninto 12 mutually exclusive branches and form a 4-level Merkle tree, and\npresent only one branch in redemption:")]),t._v(" "),a("p",[a("code",[t._v("A and C and F")]),a("br"),t._v(" "),a("code",[t._v("B and C and F")]),a("br"),t._v(" "),a("code",[t._v("A and D and F")]),a("br"),t._v(" "),a("code",[t._v(".")]),a("br"),t._v(" "),a("code",[t._v(".")]),a("br"),t._v(" "),a("code",[t._v("B and E and G")])]),t._v(" "),a("p",[t._v("One way to implement the general MAST design is using a combination of\n"),a("code",[t._v("OP_EVAL")]),t._v(", "),a("code",[t._v("OP_CAT")]),t._v(", and "),a("code",[t._v("OP_HASH256")]),t._v(". However, that will suffer from\nthe problems of "),a("code",[t._v("OP_EVAL")]),t._v(", including risks of indefinite program loop\nand inability to do static program analysis. A complicated\nimplementation is required to fix these problems and is difficult to\nreview.")]),t._v(" "),a("p",[t._v("The advantages of the current proposal are:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Subscript")]),t._v(" are located at a fixed position in the witness stack.\nThis allows static program analysis, such as static "),a("code",[t._v("SigOpsCost")]),t._v("\ncounting and early termination of scripts with disabled opcodes.")]),t._v(" "),a("li",[t._v("If different parties in a contract do not want to expose their\nscripts to each other, they may provide only "),a("code",[t._v("H(Subscript)")]),t._v(" and keep\nthe "),a("code",[t._v("Subscript")]),t._v(" private until redemption.")]),t._v(" "),a("li",[t._v("If they are willing to share the actual scripts, they may combine\nthem into one "),a("code",[t._v("Subscript")]),t._v(" for each branch, saving some "),a("code",[t._v("nOpCount")]),t._v("\nand a few bytes of witness space.")])]),t._v(" "),a("p",[t._v("The are some disadvantages, but only when the redemption condition is\nvery complicated:")]),t._v(" "),a("ul",[a("li",[t._v("It may require more branches than a general MAST design (as shown in\nthe previous example) and take more witness space in redemption")]),t._v(" "),a("li",[t._v("Creation and storage of the MAST structure may take more time and\nspace. However, such additional costs affect only the related\nparties in the contract but not any other Bitcoin users.")])]),t._v(" "),a("h3",{attrs:{id:"mast-version-mast-version"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mast-version-mast-version"}},[t._v("#")]),t._v(" MAST Version {#mast_version}")]),t._v(" "),a("p",[t._v("This proposal allows users to indicate the version of scripting language\nin the witness, which is cheaper than doing that in "),a("code",[t._v("scriptPubKey")]),t._v(" or\n"),a("code",[t._v("scriptSig")]),t._v(". Undefined versions remain anyone-can-spend and are reserved\nfor future expansions. A new version could be used for relaxing\nconstraints (e.g. the 10,000 bytes size limit of "),a("code",[t._v("MAST Script")]),t._v("), adding\nor redefining opcodes, or even introducing a completely novel scripting\nsystem.")]),t._v(" "),a("h3",{attrs:{id:"nopcount-limit-nopcount-limit"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nopcount-limit-nopcount-limit"}},[t._v("#")]),t._v(" nOpCount limit {#nopcount_limit}")]),t._v(" "),a("p",[t._v("In version 0 MAST, the extra hashing operations in calculating the\n"),a("code",[t._v("MAST Root")]),t._v(" are counted towards the 201 "),a("code",[t._v("nOpCount")]),t._v(" limit to prevent\nabusive use. This limitation is not applied to undefined "),a("code",[t._v("MAST Version")]),t._v("\nfor flexibility, but it is constrained by the 255 "),a("code",[t._v("Subscript")]),t._v(" and 32\n"),a("code",[t._v("Depth")]),t._v(" limits.")]),t._v(" "),a("h3",{attrs:{id:"script-evaluation-script-evaluation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#script-evaluation-script-evaluation"}},[t._v("#")]),t._v(" Script evaluation {#script_evaluation}")]),t._v(" "),a("p",[t._v("This proposal requires script evaluation resulting in an empty stack,\ninstead of a single "),a("code",[t._v("TRUE")]),t._v(" value as in P2WSH. This allows each party in\na contract to provide its own "),a("code",[t._v("Subscript")]),t._v(", and demonstrate the required\n"),a("code",[t._v("Input Stack")]),t._v(" to clean up its own "),a("code",[t._v("Subscript")]),t._v(". In this case, order of\nthe "),a("code",[t._v("Subscript")]),t._v(" is not important since the overall objective is to clean\nup the stack after evaluation.")]),t._v(" "),a("h2",{attrs:{id:"examples"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#examples"}},[t._v("#")]),t._v(" Examples")]),t._v(" "),a("h3",{attrs:{id:"calculation-of-mast-root-calculation-of-mast-root"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#calculation-of-mast-root-calculation-of-mast-root"}},[t._v("#")]),t._v(" Calculation of MAST Root {#calculation_of_mast_root}")]),t._v(" "),a("p",[a("code",[t._v("<img src=bip-0114/mastexample.png>")]),t._v(" "),a("code",[t._v("</img>")])]),t._v(" "),a("p",[a("code",[t._v("Subscript:")]),a("br"),t._v(" "),a("code",[t._v("SA = 1 EQUALVERIFY (0x5188)")]),a("br"),t._v(" "),a("code",[t._v("SB = 2 EQUALVERIFY (0x5288)")]),a("br"),t._v(" "),a("code",[t._v("SC = 3 EQUALVERIFY (0x5388)")]),a("br"),t._v(" "),a("code",[t._v("SD = 4 EQUALVERIFY (0x5488)")]),a("br"),t._v(" "),a("code",[t._v("SE = 5 EQUALVERIFY (0x5588)")]),a("br"),t._v(" "),a("code",[t._v("SF = 6 EQUALVERIFY (0x5688)")]),a("br"),t._v(" "),a("code",[t._v("SG = 7 EQUALVERIFY (0x5788)")]),a("br"),t._v(" "),a("code",[t._v("SH = 8 EQUALVERIFY (0x5888)")]),a("br"),t._v(" "),a("code",[t._v('M = RETURN "Hello" (0x6a0548656c6c6f)')]),a("br"),t._v(" "),a("code",[t._v("Hash:")]),a("br"),t._v(" "),a("code",[t._v("HA = H(0x01|H(SA)) = H(0x015acb54166e0db370cd1b05a29120373568dacea2abc3748459ec3da2106e4b4e) = 0xd385d7268ad7e1ec51660f833d54787d2d8d79b6b1809d9c1d06c9e71f7be204")]),a("br"),t._v(" "),a("code",[t._v("HB = H(0x02|H(SB)|H(SC)) = 0x7cbfa08e44ea9f4f996873be95d9bffd97d4b91a5af32cc5f64efb8461727cdd")]),a("br"),t._v(" "),a("code",[t._v("HF = H(0x03|H(SD)|H(SE)|H(SF)) = 0x4611414355945a7c2fcc62a53a0004821b87e68f93048ffba7a55a3cb1e9783b")]),a("br"),t._v(" "),a("code",[t._v("HG = H(0x01|H(SG)) = 0xaa5fbdf58264650eadec33691ba1e7606d0a62f570eea348a465c55bc86ffc10")]),a("br"),t._v(" "),a("code",[t._v("HC = H(0x01|H(M)) = 0x70426d480d5b28d93c5be54803681f99abf4e8df4eab4dc87aaa543f0d138159")]),a("br"),t._v(" "),a("code",[t._v("HD = H(0x0x|H(SH)) = 0x8482f6c9c3fe90dd4d533b4efedb6a241b95ec9267d1bd5aaaee36d2ce2dd6da")]),a("br"),t._v(" "),a("code",[t._v("HE = H(HA|HB) = 0x049b9f2f94f0a9bdea624e39cd7d6b27a365c6a0545bf0e9d88d86eff4894210")]),a("br"),t._v(" "),a("code",[t._v("HH = H(HC|HD) = 0xc709fdc632f370f3367da45378d1cf430c5fda6805e731ad5761c213cf2d276e")]),a("br"),t._v(" "),a("code",[t._v("HI = H(HE|HF) = 0xead5e1a1e7e41b77b794f091df9be3f0e9f41d47304eb43dece90688f69843b7")]),a("br"),t._v(" "),a("code",[t._v("HJ = H(HG|HH) = 0xd00fc690c4700d0f983f9700740066531ea826b21a4cbc62f80317261723d477")]),a("br"),t._v(" "),a("code",[t._v("Script Root = H(HI|HJ) = 0x26d5235d20daf1440a15a248f5b5b4f201392128072c55afa64a26ccc6f56bd9")]),a("br"),t._v(" "),a("code",[t._v("MAST Root = H(MAST Version|Script Root) = H(0x0000000026d5235d20daf1440a15a248f5b5b4f201392128072c55afa64a26ccc6f56bd9) = 0xb4b706e0c02eab9aba58419eb7ea2a286fb1c01d7406105fc12742bf8a3f97c9")])]),t._v(" "),a("p",[t._v("The scriptPubKey with native witness program is:")]),t._v(" "),a("p",[a("code",[t._v("1 <0xb4b706e0c02eab9aba58419eb7ea2a286fb1c01d7406105fc12742bf8a3f97c9>")]),a("br"),t._v(" "),a("code",[t._v("(0x5120b4b706e0c02eab9aba58419eb7ea2a286fb1c01d7406105fc12742bf8a3f97c9)")])]),t._v(" "),a("p",[t._v("To redeem with the "),a("code",[t._v("SD|SE|SF")]),t._v(" branch, the witness is")]),t._v(" "),a("p",[a("code",[t._v("Script_stack_1: 0x06")]),a("br"),t._v(" "),a("code",[t._v("Script_stack_2: 0x05")]),a("br"),t._v(" "),a("code",[t._v("Script_stack_3: 0x04")]),a("br"),t._v(" "),a("code",[t._v("Subscript_1:    0x5488")]),a("br"),t._v(" "),a("code",[t._v("Subscript_2:    0x5588")]),a("br"),t._v(" "),a("code",[t._v("Subscript_3:    0x5688")]),a("br"),t._v(" "),a("code",[t._v("Position:       0x01 (HF is the second hash in its level)")]),a("br"),t._v(" "),a("code",[t._v("Path (HE|HJ):   0x049b9f2f94f0a9bdea624e39cd7d6b27a365c6a0545bf0e9d88d86eff4894210d00fc690c4700d0f983f9700740066531ea826b21a4cbc62f80317261723d477")]),a("br"),t._v(" "),a("code",[t._v("Metadata:       0x03 (3 Subscript)")])]),t._v(" "),a("h3",{attrs:{id:"imbalance-mast-imbalance-mast"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#imbalance-mast-imbalance-mast"}},[t._v("#")]),t._v(" Imbalance MAST {#imbalance_mast}")]),t._v(" "),a("p",[t._v("When constructing a MAST, if the user believes that some of the branches\nare more likely to be executed, they may put them closer to the\n"),a("code",[t._v("Script Root")]),t._v(". It will save some witness space when the preferred\nbranches are actually executed.")]),t._v(" "),a("h3",{attrs:{id:"escrow-with-timeout-escrow-with-timeout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#escrow-with-timeout-escrow-with-timeout"}},[t._v("#")]),t._v(" Escrow with Timeout {#escrow_with_timeout}")]),t._v(" "),a("p",[t._v('The following is the "Escrow with Timeout" example in\n'),a("a",{attrs:{href:"bip-0112.mediawiki",title:"wikilink"}},[t._v("BIP112")]),t._v(":")]),t._v(" "),a("p",[a("code",[t._v("IF")]),a("br"),t._v(" "),a("code",[t._v("2 <Alice's pubkey> <Bob's pubkey> <Escrow's pubkey> 3 CHECKMULTISIG")]),a("br"),t._v(" "),a("code",[t._v("ELSE")]),a("br"),t._v(" "),a("code",[t._v('"30d" CHECKSEQUENCEVERIFY DROP')]),a("br"),t._v(" "),a("code",[t._v("<Alice's pubkey> CHECKSIG")]),a("br"),t._v(" "),a("code",[t._v("ENDIF")])]),t._v(" "),a("p",[t._v("Using compressed public key, the size of this script is 150 bytes.")]),t._v(" "),a("p",[t._v("With MAST, this script could be broken down into 2 mutually exclusive\nbranches:[^2]")]),t._v(" "),a("p",[a("code",[t._v("2 <Alice's pubkey> <Bob's pubkey> <Escrow's pubkey> 3 CHECKMULTISIGVERIFY (105 bytes)")]),a("br"),t._v(" "),a("code",[t._v('"30d" CHECKSEQUENCEVERIFY <Alice\'s pubkey> CHECKSIGVERIFY (42 bytes)')])]),t._v(" "),a("p",[t._v("Since only one branch will be published, it is more difficult for a\nblockchain analyst to determine the details of the escrow.")]),t._v(" "),a("h3",{attrs:{id:"hashed-time-lock-contract-hashed-time-lock-contract"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hashed-time-lock-contract-hashed-time-lock-contract"}},[t._v("#")]),t._v(" Hashed Time-Lock Contract {#hashed_time_lock_contract}")]),t._v(" "),a("p",[t._v('The following is the "Hashed TIme-Lock Contract" example in\n'),a("a",{attrs:{href:"bip-0112.mediawiki",title:"wikilink"}},[t._v("BIP112")]),t._v(":")]),t._v(" "),a("p",[a("code",[t._v("HASH160 DUP  <R-HASH>")]),t._v(" "),a("code",[t._v("EQUAL")]),a("br"),t._v(" "),a("code",[t._v("IF")]),a("br"),t._v(" "),a("code",[t._v('"24h" CHECKSEQUENCEVERIFY')]),a("br"),t._v(" "),a("code",[t._v("2DROP")]),a("br"),t._v(" "),a("code",[t._v("<Alice's pubkey>")]),a("br"),t._v(" "),a("code",[t._v("ELSE")]),a("br"),t._v(" "),a("code",[t._v("<Commit-Revocation-Hash>")]),t._v(" "),a("code",[t._v("EQUAL")]),a("br"),t._v(" "),a("code",[t._v("NOTIF")]),a("br"),t._v(" "),a("code",[t._v('"Timestamp" CHECKLOCKTIMEVERIFY DROP')]),a("br"),t._v(" "),a("code",[t._v("ENDIF")]),a("br"),t._v(" "),a("code",[t._v("<Bob's pubkey>")]),a("br"),t._v(" "),a("code",[t._v("ENDIF")]),a("br"),t._v(" "),a("code",[t._v("CHECKSIG")])]),t._v(" "),a("p",[t._v("To create a MAST Root, it is flattened to 3 mutually exclusive branches:")]),t._v(" "),a("p",[a("code",[t._v("HASH160  <R-HASH>")]),t._v(" "),a("code",[t._v('EQUALVERIFY "24h" CHECKSEQUENCEVERIFY <Alice\'s pubkey> CHECKSIGVERIFY')]),a("br"),t._v(" "),a("code",[t._v("HASH160  <Commit-Revocation-Hash>")]),t._v(" "),a("code",[t._v("EQUALVERIFY <Bob's pubkey> CHECKSIGVERIFY")]),a("br"),t._v(" "),a("code",[t._v('"Timestamp" CHECKLOCKTIMEVERIFY <Bob\'s pubkey> CHECKSIGVERIFY')])]),t._v(" "),a("p",[t._v("which significantly improves readability and reduces the witness size\nwhen it is redeemed.")]),t._v(" "),a("h3",{attrs:{id:"large-multi-signature-constructs-large-multi-signature-constructs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#large-multi-signature-constructs-large-multi-signature-constructs"}},[t._v("#")]),t._v(" Large multi-signature constructs {#large_multi_signature_constructs}")]),t._v(" "),a("p",[t._v("The current CHECKMULTISIG supports up to 20 public keys. Although it is\npossible to extend it beyond 20 keys by using multiple CHECKSIGs and\nIF/ELSE conditions, the construction could be very complicated and soon\nuse up the 10,000 bytes and 201 "),a("code",[t._v("nOpCount")]),t._v(" limit.")]),t._v(" "),a("p",[t._v("With MAST, large and complex multi-signature constructs could be\nflattened to many simple CHECKMULTISIGVERIFY conditions. For example, a\n3-of-2000 multi-signature scheme could be expressed as 1,331,334,000\n3-of-3 CHECKMULTISIGVERIFY, which forms a 31-level MAST. The\nscriptPubKey still maintains a fixed size of 34 bytes, and the\nredemption witness will be very compact, with less than 1,500 bytes.")]),t._v(" "),a("h3",{attrs:{id:"commitment-of-non-consensus-enforced-data-commitment-of-non-consensus-enforced-data"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commitment-of-non-consensus-enforced-data-commitment-of-non-consensus-enforced-data"}},[t._v("#")]),t._v(" Commitment of non-consensus enforced data {#commitment_of_non_consensus_enforced_data}")]),t._v(" "),a("p",[t._v("Currently, committing non-consensus enforced data in the scriptPubKey\nrequires the use of OP_RETURN which occupies additional block space.\nWith MAST, users may commit such data as a branch. Depends on the number\nof executable branches, inclusion of such a commitment may incur no\nextra witness space, or 32 bytes at most.")]),t._v(" "),a("p",[t._v('An useful case would be specifying "message-signing keys", which are\nnot valid for spending, but allow users to sign any message without\ntouching the cold storage "funding key".')]),t._v(" "),a("h2",{attrs:{id:"backward-compatibility-backward-compatibility"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backward-compatibility-backward-compatibility"}},[t._v("#")]),t._v(" Backward compatibility {#backward_compatibility}")]),t._v(" "),a("p",[t._v("As a soft fork, older software will continue to operate without\nmodification. Non-upgraded nodes, however, will consider MAST programs\nas anyone-can-spend scripts. Wallets should always be wary of\nanyone-can-spend scripts and treat them with suspicion.")]),t._v(" "),a("h2",{attrs:{id:"deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployment"}},[t._v("#")]),t._v(" Deployment")]),t._v(" "),a("p",[t._v("This BIP depends on "),a("a",{attrs:{href:"bip-0141.mediawiki",title:"wikilink"}},[t._v("BIP141")]),t._v(" and will be\ndeployed by version-bits "),a("a",{attrs:{href:"bip-0009.mediawiki",title:"wikilink"}},[t._v("BIP9")]),t._v(" after\nBIP141 is enforced. Exact details TBD.")]),t._v(" "),a("h2",{attrs:{id:"credits"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#credits"}},[t._v("#")]),t._v(" Credits")]),t._v(" "),a("p",[t._v("The idea of MAST originates from Russell O'Connor, Pieter Wuille, and\n"),a("a",{attrs:{href:"https://bitcointalk.org/index.php?topic=255145.msg2757327#msg2757327",target:"_blank",rel:"noopener noreferrer"}},[t._v("Peter\nTodd"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"reference-implementation-reference-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reference-implementation-reference-implementation"}},[t._v("#")]),t._v(" Reference Implementation {#reference_implementation}")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/jl2012/bitcoin/tree/bip114v2",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/jl2012/bitcoin/tree/bip114v2"),a("OutboundLink")],1),t._v(" (WIP)")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//New rules apply if version byte is 1 and witness program size is 32 bytes")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("witversion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" SCRIPT_VERIFY_MAST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    CHashWriter "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SER_GETHASH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CHashWriter "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sScriptHash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SER_GETHASH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),t._v(" nMASTVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    size_t stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" metadata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The last witness stack item is metadata")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The first byte of metadata is the number of subscripts (1 to 255)")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),t._v(" nSubscript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static_cast")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nSubscript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" nSubscript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" nOpCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nSubscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Each condition consumes a nOpCount")]),t._v("\n    sScriptHash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The rest of metadata is MAST version in minimally-coded unsigned little endian int")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size_t i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            nMASTVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static_cast")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Unknown MAST version is non-standard")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nMASTVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    sRoot "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" nMASTVersion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The second last witness stack item is the pathdata")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Size of pathdata must be divisible by 32 (0 is allowed)")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Depth of the Merkle tree is implied by the size of pathdata, and must not be greater than 32")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" pathdata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pathdata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x1F")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" depth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pathdata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("depth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Each level of Merkle tree consumes a nOpCount")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Evaluation of version 0 MAST terminates early if there are too many nOpCount")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Not enforced in unknown MAST version for upgrade flexibility")]),t._v("\n    nOpCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nOpCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" depth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nMASTVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" nOpCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" MAX_OPS_PER_SCRIPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_OP_COUNT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// path is a vector of 32-byte hashes")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("uint256"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("depth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" j "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" j "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" depth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" j"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memcpy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("j"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pathdata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" j"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The third last witness stack item is the positiondata")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Position is in minimally-coded unsigned little endian int")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" positiondata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("positiondata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),t._v(" position "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("positiondata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("positiondata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size_t k "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" k "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" positiondata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            position "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static_cast")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("positiondata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Position value must not exceed the number of leaves at the depth")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("depth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("position "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1U")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" depth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_INVALID_MAST_STACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Sub-scripts are located before positiondata")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size_t i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" nSubscript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" stacksize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CScript "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Evaluation of version 0 MAST terminates early if script is oversize")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Not enforced in unknown MAST version for upgrade flexibility")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nMASTVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scriptPubKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" subscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" MAX_SCRIPT_SIZE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_SCRIPT_SIZE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        uint256 hashSubScript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CHash256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("subscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" subscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Finalize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hashSubScript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        sScriptHash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" hashSubScript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        scriptPubKey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" scriptPubKey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" subscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Final scriptPubKey is a serialization of subscripts")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    uint256 hashScript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sScriptHash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetHash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Calculate MAST Root and compare against witness program")]),t._v("\n    uint256 rootScript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ComputeMerkleRootFromBranch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hashScript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    sRoot "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" rootScript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint256 rootMAST "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sRoot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetHash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memcmp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rootMAST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_WITNESS_PROGRAM_MISMATCH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nMASTVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        stack "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" witness"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" nSubscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" MAX_SCRIPT_ELEMENT_SIZE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_PUSH_SIZE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Script evaluation must not fail, and return an empty stack")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("EvalScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" scriptPubKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SIGVERSION_WITNESS_V1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nOpCount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SCRIPT_ERR_EVAL_FALSE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br"),a("span",{staticClass:"line-number"},[t._v("72")]),a("br"),a("span",{staticClass:"line-number"},[t._v("73")]),a("br"),a("span",{staticClass:"line-number"},[t._v("74")]),a("br"),a("span",{staticClass:"line-number"},[t._v("75")]),a("br"),a("span",{staticClass:"line-number"},[t._v("76")]),a("br"),a("span",{staticClass:"line-number"},[t._v("77")]),a("br"),a("span",{staticClass:"line-number"},[t._v("78")]),a("br"),a("span",{staticClass:"line-number"},[t._v("79")]),a("br"),a("span",{staticClass:"line-number"},[t._v("80")]),a("br"),a("span",{staticClass:"line-number"},[t._v("81")]),a("br"),a("span",{staticClass:"line-number"},[t._v("82")]),a("br"),a("span",{staticClass:"line-number"},[t._v("83")]),a("br"),a("span",{staticClass:"line-number"},[t._v("84")]),a("br"),a("span",{staticClass:"line-number"},[t._v("85")]),a("br"),a("span",{staticClass:"line-number"},[t._v("86")]),a("br"),a("span",{staticClass:"line-number"},[t._v("87")]),a("br"),a("span",{staticClass:"line-number"},[t._v("88")]),a("br"),a("span",{staticClass:"line-number"},[t._v("89")]),a("br"),a("span",{staticClass:"line-number"},[t._v("90")]),a("br"),a("span",{staticClass:"line-number"},[t._v("91")]),a("br"),a("span",{staticClass:"line-number"},[t._v("92")]),a("br"),a("span",{staticClass:"line-number"},[t._v("93")]),a("br"),a("span",{staticClass:"line-number"},[t._v("94")]),a("br"),a("span",{staticClass:"line-number"},[t._v("95")]),a("br"),a("span",{staticClass:"line-number"},[t._v("96")]),a("br"),a("span",{staticClass:"line-number"},[t._v("97")]),a("br"),a("span",{staticClass:"line-number"},[t._v("98")]),a("br"),a("span",{staticClass:"line-number"},[t._v("99")]),a("br"),a("span",{staticClass:"line-number"},[t._v("100")]),a("br"),a("span",{staticClass:"line-number"},[t._v("101")]),a("br"),a("span",{staticClass:"line-number"},[t._v("102")]),a("br"),a("span",{staticClass:"line-number"},[t._v("103")]),a("br"),a("span",{staticClass:"line-number"},[t._v("104")]),a("br"),a("span",{staticClass:"line-number"},[t._v("105")]),a("br"),a("span",{staticClass:"line-number"},[t._v("106")]),a("br"),a("span",{staticClass:"line-number"},[t._v("107")]),a("br"),a("span",{staticClass:"line-number"},[t._v("108")]),a("br"),a("span",{staticClass:"line-number"},[t._v("109")]),a("br"),a("span",{staticClass:"line-number"},[t._v("110")]),a("br"),a("span",{staticClass:"line-number"},[t._v("111")]),a("br"),a("span",{staticClass:"line-number"},[t._v("112")]),a("br"),a("span",{staticClass:"line-number"},[t._v("113")]),a("br")])]),a("p",[t._v("Copying from "),a("code",[t._v("src/consensus/merkle.cpp")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("uint256 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ComputeMerkleRootFromBranch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint256"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" leaf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("uint256"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" vMerkleBranch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),t._v(" nIndex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint256 hash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" leaf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("uint256"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("const_iterator it "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vMerkleBranch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" it "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" vMerkleBranch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            hash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Hash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            hash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Hash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        nIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])]),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[t._v("#")]),t._v(" References")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"bip-0141.mediawiki",title:"wikilink"}},[t._v("BIP141 Segregated Witness (Consensus\nlayer)")])])]),t._v(" "),a("h2",{attrs:{id:"copyright"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#copyright"}},[t._v("#")]),t._v(" Copyright")]),t._v(" "),a("p",[t._v("This document is placed in the public domain.")]),t._v(" "),a("p",[t._v("[^1]: If the version byte is 1, but the witness program is not 32 bytes,\nno further interpretation of the witness program or witness stack\nhappens. This is reserved for future extensions.")]),t._v(" "),a("p",[t._v("[^2]: In BIPXXX, it is proposed that CHECKLOCKTIMEVERIFY and\nCHECKSEQUENCEVERIFY will pop the top stack item")])])}),[],!1,null,null,null);s.default=e.exports}}]);